<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fast Food Trade Machine</title>
  <base href="./">

  <style>
    :root{
      --bg:#070a14;
      --panel:rgba(12,16,34,.72);
      --panel2:rgba(12,16,34,.52);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.08);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);
      --good:#6ef3b2;
      --bad:#ff7c7c;
      --pink:#ff8bd3;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --r:18px;
      --r2:14px;
      --tile:92px;
    }
    .logo{
  height: 34px;
  max-width: 120px;
  object-fit: contain;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(66,122,255,.18), transparent 58%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,139,211,.14), transparent 55%),
        radial-gradient(1000px 800px at 45% 90%, rgba(110,243,178,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }
    .wrap{
      height:100vh;
      padding:14px;
      display:grid;
      grid-template-rows:auto auto auto 1fr auto;
      gap:12px;
      max-width:1300px;
      margin:0 auto;
      min-height:0;
    }
    .panel{
      background:linear-gradient(180deg, rgba(20,26,56,.78), rgba(10,12,26,.70));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px 14px;
      min-height:0;
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .label{font-size:12px;color:var(--muted)}
    select, button{font:inherit}
    select{
      background:rgba(8,10,22,.72);
      color:var(--text);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:8px 10px;
      outline:none;
      max-width:260px;
    }
    button{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(30,40,90,.55), rgba(14,18,40,.6));
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s transform ease, .15s filter ease;
      user-select:none;
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform:scale(.98)}
    .btnGood{border-color:rgba(110,243,178,.35); background:linear-gradient(180deg, rgba(18,120,78,.55), rgba(14,18,40,.62))}
    .btnBad{border-color:rgba(255,124,124,.35); background:linear-gradient(180deg, rgba(135,34,52,.55), rgba(14,18,40,.62))}
    .btnPink{border-color:rgba(255,139,211,.35); background:linear-gradient(180deg, rgba(120,28,98,.55), rgba(14,18,40,.62))}
    .btnSmall{padding:8px 12px;border-radius:12px;font-size:13px}
    .statsRow{
      display:grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap:12px;
      min-height:0;
    }
    .stat{
      background:linear-gradient(180deg, rgba(20,26,56,.70), rgba(10,12,26,.70));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px 14px;
      min-height:78px;
    }
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:22px;font-weight:900;margin-top:2px}
    .stat .s{font-size:12px;color:var(--muted);margin-top:2px}
    .statWide .v{font-size:26px}
    .rightBtns{display:flex; gap:10px; justify-content:flex-end; align-items:flex-start}
    .tabs{display:flex; gap:10px; align-items:center}
    .tabBtn{
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(8,10,22,.55);
      font-weight:900;
    }
    .tabBtn.active{
      border-color:rgba(110,243,178,.45);
      box-shadow:0 0 0 3px rgba(110,243,178,.10) inset;
    }
    .main{
      background:linear-gradient(180deg, rgba(20,26,56,.66), rgba(10,12,26,.66));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px 14px;
      display:grid;
      grid-template-rows:auto 1fr;
      min-height:0;
    }
    .mainHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .mainHead h2{margin:0;font-size:16px}
    .hint{font-size:12px;color:var(--muted)}
    .tradeGrid{
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 1.1fr 1fr;
      gap:12px;
    }
    .col{
      background:rgba(8,10,22,.32);
      border:1px solid var(--stroke2);
      border-radius:var(--r2);
      padding:10px;
      min-height:0;
      overflow:hidden;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:10px; 

    }
    .colTitle{display:flex; justify-content:space-between; align-items:baseline; gap:10px}
    .colTitle .t{font-weight:1000}
    .colTitle .sub{font-size:12px;color:var(--muted)}

    .menuGrid{
      overflow:auto;
      padding-right:6px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      align-content:start;
    }
    .tile{
      border:1px solid var(--stroke2);
      background:linear-gradient(180deg, rgba(22,28,62,.55), rgba(10,12,26,.65));
      border-radius:16px;
      padding:8px;
      display:grid;
      grid-template-rows: var(--tile) auto auto;
      gap:6px;
      cursor:grab;
      user-select:none;
      position:relative;
      min-width:0;
    }
    .tile:active{cursor:grabbing}
    .thumb{
      border-radius:14px; overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .nm{
      font-weight:1000; font-size:12px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .tg{
      font-size:11px; color:var(--muted);
      display:flex; gap:6px; flex-wrap:wrap; min-height:14px;
    }
    .val{
      position:absolute; right:10px; bottom:8px;
      font-weight:1000; font-size:12px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
      padding:4px 8px;
      border-radius:999px;
      color:rgba(234,240,255,.9);
    }
    .center{
      min-height:0;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:10px;
    }
    .dropRow{
      min-height:0;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .dropZone{
      border:2px dashed rgba(255,255,255,.18);
      background:rgba(8,10,22,.24);
      border-radius:16px;
      padding:10px;
      min-height:0;
      overflow:hidden;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:10px;
    }
    .dzTitle{
      display:flex; justify-content:space-between; align-items:center;
      font-weight:1000; font-size:12px; color:rgba(234,240,255,.88);
    }
    .dzTitle .sum{font-size:11px;color:var(--muted);font-weight:900}
    .pkgGrid{
      overflow:auto;
      padding-right:6px;
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:10px;
      align-content:start;
    }
    .pkgCard{
      border:1px solid var(--stroke2);
      background:linear-gradient(180deg, rgba(22,28,62,.50), rgba(10,12,26,.60));
      border-radius:16px;
      padding:8px;
      display:grid;
      grid-template-rows:64px auto;
      gap:6px;
      position:relative;
      min-width:0;
    }
    .pkgCard .mini{border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03)}
    .pkgCard .mini img{width:100%;height:100%;object-fit:cover;display:block}
    .pkgMeta b{display:block; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .pkgMeta span{font-size:11px;color:var(--muted)}
    .rmBtn{
      position:absolute; right:8px; top:8px;
      font-size:11px; padding:6px 8px; border-radius:12px; background:rgba(0,0,0,.25)
    }
    .centerBottom{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding-top:6px; border-top:1px solid rgba(255,255,255,.07);
      color:var(--muted); font-size:12px; flex-wrap:wrap;
    }

    /* Inbox */
    .inbox{
      min-height:0;
      overflow:auto;
      padding-right:6px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      align-content:start;
    }
    .offerCard{
      border:1px solid var(--stroke2);
      background:linear-gradient(180deg, rgba(22,28,62,.55), rgba(10,12,26,.65));
      border-radius:16px;
      padding:10px;
      display:grid;
      gap:10px;
      cursor:pointer;
      min-width:0;
    }
    .offerCard.active{outline:3px solid rgba(110,243,178,.14); border-color:rgba(110,243,178,.35)}
    .offerTop{display:flex; justify-content:space-between; align-items:flex-start; gap:10px}
    .offerTop b{font-size:13px}
    .badge{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--stroke2); background:rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .badge.fair{border-color:rgba(110,243,178,.35); color:rgba(110,243,178,.95)}
    .badge.fleece{border-color:rgba(255,124,124,.35); color:rgba(255,124,124,.95)}
    .badge.block{border-color:rgba(255,139,211,.40); color:rgba(255,139,211,.95)}
    .offerBody{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .offerSide .st{font-size:11px;color:var(--muted);font-weight:1000;margin-bottom:6px}
    .offerMiniGrid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px; align-content:start}
    .offerMini{
      border:1px solid var(--stroke2);
      border-radius:14px; overflow:hidden;
      background:rgba(255,255,255,.03);
      height:70px; position:relative;
    }
    .offerMini img{width:100%;height:100%;object-fit:cover;display:block}
    .offerMini .cap{
      position:absolute; left:6px; right:6px; bottom:6px;
      font-size:10px; font-weight:1000;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      border-radius:10px; padding:3px 6px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Banner */
    #tradeBanner{
      position:fixed; left:50%; top:14px; transform:translateX(-50%);
      z-index:50; font-weight:1000; font-size:14px;
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25);
      opacity:0; pointer-events:none; box-shadow:0 16px 50px rgba(0,0,0,.45);
    }
    @keyframes bannerIn{
      0%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.98)}
      10%{opacity:1}
      40%{opacity:1; transform:translateX(-50%) translateY(0) scale(1)}
      100%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.98)}
    }
    @keyframes screenShake{
      0%{transform:translate(0,0)}
      15%{transform:translate(-7px, 2px)}
      30%{transform:translate(7px, -2px)}
      45%{transform:translate(-6px, -1px)}
      60%{transform:translate(6px, 1px)}
      75%{transform:translate(-4px, 2px)}
      100%{transform:translate(0,0)}
    }

    #confettiCanvas{position:fixed; inset:0; pointer-events:none; z-index:55}
    #modalMask{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:60; padding:16px}
    #modal{
      width:min(980px, 100%);
      background:linear-gradient(180deg, rgba(20,26,56,.92), rgba(10,12,26,.92));
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px;
      box-shadow:0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .mHead{padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; justify-content:space-between; gap:12px}
    .mTitleWrap{display:grid; gap:4px}
    #mTitle{font-weight:1000}
    #mSub{font-size:12px;color:var(--muted)}
    .mBody{padding:14px 16px; display:grid; grid-template-columns:1fr 1fr; gap:12px; border-bottom:1px solid rgba(255,255,255,.10)}
    .mSide{border:1px solid rgba(255,255,255,.10); border-radius:16px; background:rgba(8,10,22,.35); padding:10px; min-height:160px; overflow:auto}
    .mSide h4{margin:0 0 8px;font-size:12px}
    .mEval{padding:12px 16px; display:flex; justify-content:space-between; gap:12px; font-weight:1000}
    .mBtns{padding:14px 16px; display:flex; justify-content:flex-end; gap:10px}

    ::-webkit-scrollbar{width:10px;height:10px}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.10); border-radius:999px}
    ::-webkit-scrollbar-track{background:transparent}
  </style>
</head>
<body>
  <canvas id="confettiCanvas"></canvas>
  <div id="tradeBanner"></div>

  <div class="wrap">

    <!-- Setup -->
    <div class="panel">
      <div class="row">
        <div class="label">My Chain</div>
        <select id="myTeam"></select>

        <div class="label">Fairness</div>
        <select id="fairness">
          <option value="8">¬±8 normal</option>
          <option value="12">¬±12 loose</option>
          <option value="5">¬±5 strict</option>
        </select>

        <button id="startBtn" class="btnGood">Start Run</button>
      </div>
      <div class="label" style="margin-top:6px;">
        Tip: images go in <b>assets/items/</b>. Missing images fall back to placeholder.
      </div>
    </div>

    <!-- Stats -->
    <div class="statsRow">
      <div class="stat statWide">
        <div class="k">You are CEO of</div>
        <div class="v" id="ceoTeam">‚Äî</div>
        <div class="s">Goal: <b id="goalNum">1000</b> Power by Turn 10</div>
      </div>
      <div class="stat">
        <div class="k">Turn</div>
        <div class="v"><span id="turnNum">1</span>/10</div>
<div class="s">
  Inbox: <span id="inboxCount">0</span> ‚Ä¢ Trades left: <span id="tradesLeft">3</span>
</div>
      </div>
      <div class="stat">
        <div class="k">Menu Power</div>
        <div class="v" id="powerNum">0</div>
        <div class="s">Trade to improve.</div>
      </div>
      <div class="stat">
        <div class="k">Reputation</div>
        <div class="v" id="repNum">50</div>
        <div class="s" id="repMood">Neutral üôÇ</div>
      </div>
      <div class="rightBtns">
        <button id="clearProposal" class="btnSmall">Clear</button>
        <button id="newRun" class="btnSmall btnPink">New</button>
        <button id="endTurn" class="btnSmall btnBad">End Turn ‚Üí</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tInbox" class="tabBtn">üì• Inbox</button>
      <button id="tMake" class="tabBtn active">üõ†Ô∏è Make Offer</button>
    </div>

    <!-- Main -->
    <div class="main">
      <div class="mainHead">
        <div>
          <h2 id="mainTitle">Trade Center (Outgoing Offer)</h2>
          <div class="hint" id="mainHint">Drag from the grids into the center.</div>
        </div>
        <div class="row" id="makeControls">
          <div class="label">Target CEO</div>
          <select id="target"></select>
          <button id="send" class="btnGood">Send Offer</button>
        </div>
        <div class="row" id="inboxControls" style="display:none;">
          <button id="accept" class="btnSmall btnGood">Accept</button>
          <button id="counter" class="btnSmall btnPink">Counter</button>
          <button id="reject" class="btnSmall btnBad">Reject</button>
        </div>
      </div>

      <!-- Make -->
      <div id="panelMake" class="tradeGrid">
        <div class="col">
         <div class="colTitle">
  <div class="t">Your Menu</div>
  <img id="myLogo" class="logo"/>
  <div class="sub"><span id="myCount">0</span> items</div>
</div>

          <div id="myMenu" class="menuGrid"></div>
        </div>

        <div class="col center">
          <div class="dropRow">
            <div class="dropZone" id="dzGive">
              <div class="dzTitle">You give <span class="sum">Total: <span id="sumGive">0</span></span></div>
              <div id="giveYou" class="pkgGrid"></div>
            </div>
            <div class="dropZone" id="dzGet">
              <div class="dzTitle">They give <span class="sum">Total: <span id="sumGet">0</span></span></div>
              <div id="giveThey" class="pkgGrid"></div>
            </div>
          </div>
          <div class="centerBottom">
            <div id="netLine">Net: ‚Äî</div>
            <div id="likelyLine">They likely: ‚Äî</div>
          </div>
        </div>

        <div class="col">
         <div class="colTitle">
  <div class="t">Target Menu</div>
  <img id="tgLogo" class="logo"/>
  <div class="sub"><span id="tgCount">0</span> items</div>
</div>

          <div id="tgMenu" class="menuGrid"></div>
        </div>
      </div>

      <!-- Inbox -->
      <div id="panelInbox" style="display:none; min-height:0;">
        <div class="inbox" id="inbox"></div>
      </div>
    </div>

    <div class="panel" id="log" style="height:92px; overflow:auto; font-size:12px; color:rgba(234,240,255,.75)"></div>
  </div>

  <!-- Modal -->
  <div id="modalMask" onclick="if(event.target.id==='modalMask') closeModal()">
    <div id="modal">
      <div class="mHead">
        <div class="mTitleWrap">
          <div id="mTitle">‚Äî</div>
          <div id="mSub"></div>
        </div>
        <div id="mBadge" class="badge" style="display:none">‚Äî</div>
      </div>
      <div class="mBody">
        <div class="mSide"><h4>You give</h4><div id="mYou"></div></div>
        <div class="mSide"><h4>They give</h4><div id="mThey"></div></div>
      </div>
      <div class="mEval">
        <div id="mEval">‚Äî</div>
        <div id="mEval2">‚Äî</div>
      </div>
      <div class="mBtns" id="mButtons"></div>
    </div>
  </div>

  <script>
/* ================= DATA ================= */
const PLACEHOLDER = "assets/items/placeholder.jpg";

const DATA_SEED = {
  "McDonald's":[
    {name:"Big Mac",base:86,tags:["iconic"],img:"assets/items/big-mac.jpg"},
    {name:"Fries",base:80,tags:["iconic","speed"],img:"assets/items/mcd-fries.jpg"},
    {name:"Nuggets (10pc)",base:78,tags:["iconic"],img:"assets/items/nuggets.jpg"},
    {name:"McFlurry",base:74,tags:["broken"],img:"assets/items/mcflurry.jpg"},
    {name:"Egg McMuffin",base:76,tags:["iconic"],img:"assets/items/egg-mcmuffin.jpg"},
    {name:"Hash Browns",base:70,tags:["speed"],img:"assets/items/hash-browns.jpg"},
    {name:"Filet-O-Fish",base:72,tags:["iconic"],img:"assets/items/filet-o-fish.jpg"}
  ],
  "Taco Bell":[
    {name:"Baja Blast",base:90,tags:["iconic"],img:"assets/items/baja-blast.jpg"},
    {name:"Crunchwrap Supreme",base:88,tags:["iconic"],img:"assets/items/crunchwrap.jpg"},
    {name:"Doritos Locos Taco",base:84,tags:["iconic"],img:"assets/items/doritos-locos.jpg"},
    {name:"Quesadilla",base:80,tags:["iconic"],img:"assets/items/tb-quesadilla.jpg"},
    {name:"Nacho Fries (LTO)",base:83,tags:["lto"],img:"assets/items/nacho-fries.jpg"},
    {name:"Fire Sauce",base:64,tags:["sauce"],img:"assets/items/fire-sauce.jpg"},
    {name:"Cinnamon Twists",base:70,tags:["dessert"],img:"assets/items/cinnamon-twists.jpg"}
  ],
  "Chick-fil-A":[
    {name:"Chicken Sandwich",base:90,tags:["iconic"],img:"assets/items/chicken-sandwich.jpg"},
    {name:"Spicy Chicken Sandwich",base:92,tags:["iconic"],img:"assets/items/spicy-chicken-sandwich.jpg"},
    {name:"Waffle Fries",base:86,tags:["iconic","speed"],img:"assets/items/waffle-fries.jpg"},
    {name:"Nuggets (12ct)",base:82,tags:["iconic"],img:"assets/items/cfa-nuggets.jpg"},
    {name:"Chick-fil-A Sauce",base:66,tags:["sauce"],img:"assets/items/cfa-sauce.jpg"},
    {name:"Lemonade",base:75,tags:["iconic"],img:"assets/items/cfa-lemonade.jpg"},
    {name:"Mac & Cheese",base:74,tags:["iconic"],img:"assets/items/mac-and-cheese.jpg"}
  ],
  "Raising Cane's":[
    {name:"Box Combo",base:88,tags:["iconic"],img:"assets/items/box-combo.jpg"},
    {name:"Chicken Fingers",base:86,tags:["iconic"],img:"assets/items/chicken-fingers.jpg"},
    {name:"Cane's Sauce",base:70,tags:["sauce","iconic"],img:"assets/items/canes-sauce.jpg"},
    {name:"Texas Toast",base:76,tags:["iconic"],img:"assets/items/texas-toast.jpg"},
    {name:"Crinkle Fries",base:80,tags:["speed"],img:"assets/items/crinkle-fries.jpg"},
    {name:"Lemonade",base:74,tags:["iconic"],img:"assets/items/rc-lemonade.jpg"},
    {name:"Coleslaw",base:66,tags:[],img:"assets/items/coleslaw.jpg"}
  ],
  "Burger King":[
    {name:"Whopper",base:84,tags:["iconic"],img:"assets/items/whopper.jpg"},
    {name:"Fries",base:76,tags:["speed"],img:"assets/items/bk-fries.jpg"},
    {name:"Onion Rings",base:73,tags:["iconic"],img:"assets/items/onion-rings.jpg"},
    {name:"Chicken Fries",base:76,tags:["iconic"],img:"assets/items/chicken-fries.jpg"},
    {name:"Impossible Whopper (LTO)",base:78,tags:["lto"],img:"assets/items/impossible-whopper.jpg"},
    {name:"Croissan'wich",base:72,tags:["iconic"],img:"assets/items/croissanwich.jpg"},
    {name:"Chocolate Pie",base:70,tags:["dessert"],img:"assets/items/chocolate-pie.jpg"}
  ],
  "Chipotle":[
    {name:"Burrito",base:86,tags:["iconic"],img:"assets/items/burrito.jpg"},
    {name:"Bowl",base:86,tags:["iconic"],img:"assets/items/bowl.jpg"},
    {name:"Chips & Guac",base:80,tags:["upgrade","iconic"],img:"assets/items/chips-guac.jpg"},
    {name:"Queso",base:74,tags:["upgrade"],img:"assets/items/queso.jpg"},
    {name:"Barbacoa",base:82,tags:["iconic"],img:"assets/items/barbacoa.jpg"},
    {name:"Vinaigrette",base:64,tags:["sauce"],img:"assets/items/vinaigrette.jpg"},
    {name:"Hot Salsa",base:64,tags:["sauce"],img:"assets/items/hot-salsa.jpg"}
  ],
  "Panda Express":[
    {name:"Orange Chicken",base:90,tags:["iconic"],img:"assets/items/orange-chicken.jpg"},
    {name:"Chow Mein",base:82,tags:["iconic"],img:"assets/items/chow-mein.jpg"},
    {name:"Fried Rice",base:80,tags:["iconic"],img:"assets/items/fried-rice.jpg"},
    {name:"Beijing Beef",base:84,tags:["iconic"],img:"assets/items/beijing-beef.jpg"},
    {name:"Walnut Shrimp (LTO)",base:86,tags:["lto"],img:"assets/items/walnut-shrimp.jpg"},
    {name:"Super Greens",base:70,tags:[],img:"assets/items/super-greens.jpg"},
    {name:"Fortune Cookie",base:62,tags:["nostalgia"],img:"assets/items/fortune-cookie.jpg"}
  ],
  "Subway":[
    {name:"Footlong Sub",base:80,tags:["iconic"],img:"assets/items/footlong-sub.jpg"},
    {name:"Italian B.M.T.",base:82,tags:["iconic"],img:"assets/items/italian-bmt.jpg"},
    {name:"Meatball Marinara",base:80,tags:["iconic"],img:"assets/items/meatball.jpg"},
    {name:"Tuna Sub",base:74,tags:["iconic"],img:"assets/items/tuna-sub.jpg"},
    {name:"Cookies",base:70,tags:["dessert"],img:"assets/items/subway-cookies.jpg"},
    {name:"Southwest Sauce",base:64,tags:["sauce"],img:"assets/items/subway-southwest.jpg"},
    {name:"Soft Pretzel (LTO)",base:72,tags:["lto"],img:"assets/items/soft-pretzel.jpg"}
  ],
  "Domino's":[
    {name:"Pepperoni Pizza",base:90,tags:["iconic"],img:"assets/items/pepperoni-pizza.jpg"},
    {name:"Cheesy Bread",base:82,tags:["iconic"],img:"assets/items/cheesy-bread.jpg"},
    {name:"Wings",base:84,tags:["iconic"],img:"assets/items/wings.jpg"},
    {name:"Cinnamon Twists",base:74,tags:["dessert"],img:"assets/items/dom-cinnamon.jpg"},
    {name:"Lava Cake",base:78,tags:["dessert","iconic"],img:"assets/items/lava-cake.jpg"},
    {name:"Garlic Dip",base:64,tags:["sauce"],img:"assets/items/garlic-dip.jpg"},
    {name:"Stuffed Crust (LTO)",base:82,tags:["lto"],img:"assets/items/stuffed-crust.jpg"}
  ],
  "Wendy's":[
    {name:"Baconator",base:88,tags:["iconic"],img:"assets/items/baconator.jpg"},
    {name:"Dave's Single",base:82,tags:["iconic"],img:"assets/items/daves-single.jpg"},
    {name:"Spicy Nuggets",base:83,tags:["iconic"],img:"assets/items/spicy-nuggets.jpg"},
    {name:"Spicy Chicken Sandwich",base:84,tags:["iconic"],img:"assets/items/wendys-spicy-chicken.jpg"},
    {name:"Fries",base:76,tags:["speed"],img:"assets/items/wendys-fries.jpg"},
    {name:"Frosty",base:80,tags:["iconic"],img:"assets/items/frosty.jpg"},
    {name:"Chili",base:72,tags:["iconic"],img:"assets/items/chili.jpg"}
  ]
};
const LOGOS = {
  "McDonald's": "assets/logos/mcdonalds.png",
  "Taco Bell": "assets/logos/taco-bell.png",
  "Chick-fil-A": "assets/logos/chick-fil-a.png",
  "Raising Cane's": "assets/logos/raising-canes.png",
  "Burger King": "assets/logos/burger-king.png",
  "Chipotle": "assets/logos/chipotle.png",
  "Panda Express": "assets/logos/panda-express.png",
  "Subway": "assets/logos/subway.png",
  "Domino's": "assets/logos/dominos.png",
  "Wendy's": "assets/logos/wendys.png"
};

const S = {
  started:false, tab:"make",
  my:null, target:null, fairness:8,
  turn:1, rep:50, goal:1000,
  tradesPerTurn: 3,
  tradesLeft: 3,
  DATA:{},
  giveYou:[], giveThey:[],
  inbox:[], inboxSel:null
};

/* ================= HELPERS ================= */
const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
const cloneItem = (it)=>({...it, tags:[...(it.tags||[])]});
const roster = (t)=>S.DATA[t]||[];
const findItem = (team,name)=>roster(team).find(x=>x.name===name)||null;

function imgHTML(src, alt){
  const safe = src || PLACEHOLDER;
  return `<img src="${esc(safe)}" alt="${esc(alt||"item")}"
    onerror="this.onerror=null;this.src='${PLACEHOLDER}'">`;
}
const safeImg = (it)=> it?.img || PLACEHOLDER;

function itemValue(it){
  if(!it) return 0;
  let v = Number(it.base||0);
  if((it.tags||[]).includes("broken")) v = Math.max(0, v-12);
  return v;
}
const sumPkg = (arr)=>arr.reduce((a,it)=>a+itemValue(it),0);
const powerOf = (t)=>roster(t).reduce((s,it)=>s+itemValue(it),0);

function logLine(t){
  const el = $("log");
  el.innerHTML += `‚Ä¢ ${esc(t)}<br/>`;
  el.scrollTop = el.scrollHeight;
}

/* ================= UI FX ================= */
function showBanner(text, color, shake=false){
  const banner = $("tradeBanner");
  banner.textContent = text;
  banner.style.color = color;
  banner.style.animation = "none";
  banner.offsetHeight;
  banner.style.animation = "bannerIn 1400ms ease-out forwards";
  if(shake){
    document.body.style.animation="none";
    document.body.offsetHeight;
    document.body.style.animation="screenShake 520ms ease-in-out";
  }
}

/* Confetti (lightweight) */
let confettiRunning=false;
function resizeConfetti(){
  const c = $("confettiCanvas");
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  c.width = Math.floor(window.innerWidth * dpr);
  c.height = Math.floor(window.innerHeight * dpr);
}
window.addEventListener("resize", resizeConfetti);

function startConfetti(durationMs=1500, count=140){
  if(confettiRunning) return;
  confettiRunning=true;
  resizeConfetti();
  const c = $("confettiCanvas");
  const ctx = c.getContext("2d");
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const W=c.width, H=c.height;
  const parts=[];
  for(let i=0;i<count;i++){
    parts.push({
      x:Math.random()*W,
      y:-Math.random()*H*0.5,
      vx:(Math.random()*2-1)*2.0*dpr,
      vy:(Math.random()*2+2.6)*2.6*dpr,
      s:(Math.random()*6+6)*dpr,
      r:Math.random()*Math.PI,
      vr:(Math.random()*2-1)*0.12,
      a:.9
    });
  }
  const t0=performance.now();
  function tick(t){
    const dt=t-t0;
    ctx.clearRect(0,0,W,H);
    for(const p of parts){
      p.x+=p.vx; p.y+=p.vy; p.r+=p.vr;
      p.vy+=0.04*dpr; p.vx*=0.995;
      if(p.x<-40*dpr) p.x=W+40*dpr;
      if(p.x>W+40*dpr) p.x=-40*dpr;
      p.a=Math.max(0, Math.min(.9, 1-dt/durationMs));

      ctx.save();
      ctx.globalAlpha=p.a;
      ctx.translate(p.x,p.y);
      ctx.rotate(p.r);
      ctx.fillStyle=`hsl(${Math.floor((p.x/W)*360)},90%,60%)`;
      ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s*0.65);
      ctx.restore();
    }
    if(dt<durationMs) requestAnimationFrame(tick);
    else { ctx.clearRect(0,0,W,H); confettiRunning=false; }
  }
  requestAnimationFrame(tick);
}

function fxStatus(status, blockbuster=false){
  if(blockbuster){
    showBanner("üö® BLOCKBUSTER TRADE!", "#ff8bd3", true);
    startConfetti(1800, 180);
    return;
  }
  if(status==="accepted") showBanner("‚úÖ TRADE ACCEPTED", "#6ef3b2", false);
  if(status==="countered") showBanner("üîÅ COUNTEROFFER!", "#ff8bd3", false);
  if(status==="rejected") showBanner("‚ùå TRADE REJECTED", "#ff7c7c", true);
}

/* ================= MODAL ================= */
function closeModal(){ $("modalMask").style.display="none"; }

function pkgCardHTML(it, removable){
  const name = it?.name || "Unknown";
  const v = itemValue(it);
  return `
    <div class="pkgCard" data-name="${esc(name)}">
      <div class="mini">${imgHTML(safeImg(it), name)}</div>
      <div class="pkgMeta" style="min-width:0;">
        <b title="${esc(name)}">${esc(name)}</b>
        <span>Value: ${v}</span>
      </div>
      ${removable ? `<button class="rmBtn" data-remove="1" title="Remove">Remove</button>` : ``}
    </div>
  `;
}

function openModal({title, sub, badgeObj, youGiveItems, theyGiveItems, eval1, eval2, buttonsHTML}){
  $("mTitle").textContent = title;
  $("mSub").textContent = sub || "";

  const b = $("mBadge");
  if(badgeObj){
    b.style.display="";
    b.className=`badge ${badgeObj.cls}`;
    b.textContent=badgeObj.txt;
  } else {
    b.style.display="none";
  }

  $("mYou").innerHTML = (youGiveItems?.length)
    ? youGiveItems.map(it=>pkgCardHTML(it,false)).join("")
    : `<div class="label">Nothing</div>`;
  $("mThey").innerHTML = (theyGiveItems?.length)
    ? theyGiveItems.map(it=>pkgCardHTML(it,false)).join("")
    : `<div class="label">Nothing</div>`;

  $("mEval").textContent = eval1 || "";
  $("mEval2").textContent = eval2 || "";
  $("mButtons").innerHTML = buttonsHTML || `<button class="btnGood" onclick="closeModal()">OK</button>`;
  $("modalMask").style.display="flex";
}

/* ================= TRADE LOGIC ================= */
function fairnessBadge(delta){
  if(delta >= -S.fairness && delta <= S.fairness) return {cls:"fair", txt:"FAIR ü§ù"};
  if(delta < -S.fairness) return {cls:"fleece", txt:"FLEECE üòà"};
  return {cls:"block", txt:"BLOCKBUSTER üö®"};
}

function aiDecide(net){
  // net = (value you get) - (value you give)
  // negative net = bad for them

  const luck = Math.random(); // 0 ‚Üí 1
  const pain = -net;         // how bad this is for them

  // If it's good for them, usually accept
  if(pain <= 0){
    if(luck < 0.80) return "accepted";
    if(luck < 0.95) return "countered";
    return "rejected";
  }

  // Slightly bad for them (small fleece)
  if(pain <= 10){
    if(luck < 0.35) return "accepted";   // YOU FLEECE THEM SOMETIMES üòà
    if(luck < 0.75) return "countered";
    return "rejected";
  }

  // Pretty bad for them
  if(pain <= 20){
    if(luck < 0.15) return "accepted";   // rare steals for viral moments
    if(luck < 0.55) return "countered";
    return "rejected";
  }

  // Horrible deal for them
  if(luck < 0.05) return "accepted";     // 5% YOLO accept (BLOCKBUSTER STEAL)
  if(luck < 0.30) return "countered";
  return "rejected";
}


function isBlockbuster(youGiveItems, theyGiveItems){
  const top = (it)=> (it && (it.base ?? 0) >= 89);
  return [...youGiveItems, ...theyGiveItems].some(top);
}

function executeTrade(otherTeam, youGiveItems, theyGiveItems){
  const myR = roster(S.my);
  const thR = roster(otherTeam);

  const giveNames = new Set(youGiveItems.map(i=>i.name));
  const getNames  = new Set(theyGiveItems.map(i=>i.name));

  S.DATA[S.my] = myR.filter(it => !giveNames.has(it.name)).concat(theyGiveItems.map(cloneItem));
  S.DATA[otherTeam] = thR.filter(it => !getNames.has(it.name)).concat(youGiveItems.map(cloneItem));
}

/* ================= DRAG & DROP ================= */
function setDrag(el, payload){
  el.draggable = true;
  el.addEventListener("dragstart", (e)=>{
    e.dataTransfer.setData("application/json", JSON.stringify(payload));
    e.dataTransfer.effectAllowed = "copy";
  });
}
function wireDrop(zoneEl, onDrop){
  zoneEl.addEventListener("dragover", (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect="copy"; });
  zoneEl.addEventListener("drop", (e)=>{
    e.preventDefault();
    try{
      const payload = JSON.parse(e.dataTransfer.getData("application/json"));
      onDrop(payload);
    }catch(_){}
  });
}

/* ================= RENDER ================= */
function tileHTML(it){
  const tags = (it.tags||[]).map(t=>`#${t}`).join(" ");
  const v = itemValue(it);
  return `
    <div class="tile" data-name="${esc(it.name)}">
      <div class="thumb">${imgHTML(safeImg(it), it.name)}</div>
      <div class="nm" title="${esc(it.name)}">${esc(it.name)}</div>
      <div class="tg">${esc(tags)}</div>
      <div class="val">${v}</div>
    </div>
  `;
}

function renderStats(){
  $("ceoTeam").textContent = S.my || "‚Äî";
  $("turnNum").textContent = S.turn;
  $("repNum").textContent = S.rep;
  $("powerNum").textContent = S.my ? powerOf(S.my) : 0;
  $("inboxCount").textContent = S.inbox.length;
  $("goalNum").textContent = S.goal;

  const mood = S.rep >= 60 ? "Loved üòÑ" : (S.rep <= 40 ? "Sketchy üò¨" : "Neutral üôÇ");
  $("repMood").textContent = mood;

  // Safe update: only set if the element exists
  const tl = $("tradesLeft");
  if(tl) tl.textContent = S.tradesLeft ?? 0;
}


function renderMenus(){
  S.target = $("target").value;

$("myLogo").src = LOGOS[S.my] || "";
$("tgLogo").src = LOGOS[S.target] || "";
$("myLogo").style.display = LOGOS[S.my] ? "" : "none";
$("tgLogo").style.display = LOGOS[S.target] ? "" : "none";


  $("myCount").textContent = roster(S.my).length;
  $("tgCount").textContent = roster(S.target).length;

  $("myMenu").innerHTML = roster(S.my).map(tileHTML).join("");
  $("tgMenu").innerHTML = roster(S.target).map(tileHTML).join("");

  for(const el of $("myMenu").querySelectorAll(".tile")){
    const name = el.getAttribute("data-name");
    setDrag(el, {team:S.my, item: findItem(S.my, name)});
  }
  for(const el of $("tgMenu").querySelectorAll(".tile")){
    const name = el.getAttribute("data-name");
    setDrag(el, {team:S.target, item: findItem(S.target, name)});
  }
}

function renderPackages(){
  $("giveYou").innerHTML = S.giveYou.length
    ? S.giveYou.map(it=>pkgCardHTML(it,true)).join("")
    : `<div class="label">Drop items here...</div>`;
  $("giveThey").innerHTML = S.giveThey.length
    ? S.giveThey.map(it=>pkgCardHTML(it,true)).join("")
    : `<div class="label">Drop items here...</div>`;

  for(const btn of document.querySelectorAll(".rmBtn")){
    btn.onclick = (e)=>{
      const card = e.target.closest(".pkgCard");
      const nm = card.getAttribute("data-name");
      S.giveYou = S.giveYou.filter(it => it.name !== nm);
      S.giveThey = S.giveThey.filter(it => it.name !== nm);
      render();
    };
  }

  const a = sumPkg(S.giveYou);
  const b = sumPkg(S.giveThey);
  $("sumGive").textContent = a;
  $("sumGet").textContent = b;

  const net = b - a;
  $("netLine").textContent = net===0 ? "Net: EVEN" : (net>0 ? `Net: You WIN by ${net}` : `Net: You LOSE by ${Math.abs(net)}`);
  $("likelyLine").textContent = `They likely: ${aiDecide(net).toUpperCase()}`;
}

function renderInbox(){
  const wrapMini = (it)=>`
    <div class="offerMini">
      ${imgHTML(safeImg(it), it.name)}
      <div class="cap">${esc(it.name)}</div>
    </div>
  `;

  $("inbox").innerHTML = S.inbox.map(off=>{
    const active = (S.inboxSel===off.id) ? "active" : "";
    return `
      <div class="offerCard ${active}" data-id="${esc(off.id)}">
        <div class="offerTop">
          <div>
            <b>${esc(off.fromTeam)} ‚Üí ${esc(off.toTeam)}</b>
            <div class="label" style="margin-top:3px;">${esc(off.quote)}</div>
          </div>
          <div class="badge ${off.badge.cls}">${esc(off.badge.txt)}</div>
        </div>
        <div class="offerBody">
          <div class="offerSide">
            <div class="st">You receive</div>
            <div class="offerMiniGrid">${off.giveYou.map(wrapMini).join("")}</div>
          </div>
          <div class="offerSide">
            <div class="st">You give</div>
            <div class="offerMiniGrid">${off.giveThey.map(wrapMini).join("")}</div>
          </div>
        </div>
        <div class="label">Net: ${off.delta>0?`You WIN by ${off.delta}`:off.delta<0?`You LOSE by ${Math.abs(off.delta)}`:"EVEN"}</div>
      </div>
    `;
  }).join("");

  for(const c of $("inbox").querySelectorAll(".offerCard")){
    c.onclick = ()=>{
      S.inboxSel = c.getAttribute("data-id");
      renderInbox();
    };
  }
}

function setTab(tab){
  S.tab = tab;

  $("panelMake").style.display = (tab==="make") ? "" : "none";
  $("panelInbox").style.display = (tab==="inbox") ? "" : "none";

  $("makeControls").style.display = (tab==="make") ? "" : "none";
  $("inboxControls").style.display = (tab==="inbox") ? "" : "none";

  $("tInbox").classList.toggle("active", tab==="inbox");
  $("tMake").classList.toggle("active", tab==="make");

  $("mainTitle").textContent = (tab==="make") ? "Trade Center (Outgoing Offer)" : "Inbox";
  $("mainHint").textContent = (tab==="make") ? "Drag from the grids into the center." : "Click an offer to select it, then Accept/Counter/Reject.";
}

function render(){
  renderStats();
  if(!S.started) return;
  if(S.tab==="make"){
    renderMenus();
    renderPackages();
  } else {
    renderInbox();
  }
}

/* ================= INBOX GEN ================= */
function makeRandomOffer(fromTeam, toTeam){
  const fromR = roster(fromTeam);
  const toR = roster(toTeam);

  const pick = (arr, k)=>{
    const copy=[...arr];
    const out=[];
    while(copy.length && out.length<k){
      out.push(copy.splice(Math.floor(Math.random()*copy.length),1)[0]);
    }
    return out;
  };

  const giveThey = pick(fromR, Math.random()<0.6?1:2); // they give you
  const giveYou  = pick(toR,  Math.random()<0.6?1:2); // you give them

  const youSum = sumPkg(giveYou);
  const thSum  = sumPkg(giveThey);
  const delta = thSum - youSum;

  const badge = fairnessBadge(delta);
  const id = (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2));

  return {
    id, fromTeam, toTeam,
    giveYou: giveThey,   // receive
    giveThey: giveYou,   // give
    delta,
    badge,
    quote: badge.cls==="fleece" ? "‚ÄúThis is extremely fair.‚Äù" :
           badge.cls==="block" ? "‚ÄúThis could break the internet.‚Äù" :
           "‚ÄúClean trade.‚Äù"
  };
}

function generateInbox(){
  const teams = Object.keys(DATA_SEED).filter(t=>t!==S.my);
  S.inbox = [];
  for(let i=0;i<3;i++){
    const from = teams[Math.floor(Math.random()*teams.length)];
    S.inbox.push(makeRandomOffer(from, S.my));
  }
  S.inboxSel = S.inbox[0]?.id || null;
}

/* ================= BUTTONS ================= */
function startRun(){
  S.started = true;
  S.turn = 1;
  S.tradesLeft = S.tradesPerTurn;
  S.rep = 50;
  S.goal = 1100; // tougher than 750
  S.fairness = Number($("fairness").value) || 8;
  S.my = $("myTeam").value;

  // copy seed to live data
  S.DATA = {};
  for(const t of Object.keys(DATA_SEED)){
    S.DATA[t] = (DATA_SEED[t]||[]).map(cloneItem);
  }

  // set target to a different team
  S.target = Object.keys(DATA_SEED).find(t=>t!==S.my) || Object.keys(DATA_SEED)[0];
  $("target").value = S.target;

  S.giveYou = [];
  S.giveThey = [];

  logLine(`New run: CEO of ${S.my}. Turn 1 begins.`);
  generateInbox();
  setTab("make");
  $("send").disabled = false;
$("send").style.opacity = 1;

  render();
}

function sendOffer(){
  if(S.tradesLeft <= 0){
  showBanner("‚õî No trades left ‚Äî End Turn!", "#ff8bd3", true);
  return;
}
  if(!S.started) return;

  S.target = $("target").value;
  const other = S.target;

  if(!S.giveYou.length && !S.giveThey.length){
    showBanner("‚ö†Ô∏è Add items to both sides", "#ff8bd3", false);
    return;
  }

  const youGive = S.giveYou;
  const theyGive = S.giveThey;

  const a = sumPkg(youGive);
  const b = sumPkg(theyGive);
  const net = b - a;

  const decision = aiDecide(net);
 S.tradesLeft--;
 if(S.tradesLeft <= 0){
  $("send").disabled = true;
  $("send").style.opacity = 0.55;
}
  const badge = fairnessBadge(net);
  const blockbuster = isBlockbuster(youGive, theyGive);

  if(decision==="accepted"){
    executeTrade(other, youGive, theyGive);
    fxStatus("accepted", blockbuster);

    openModal({
      title: blockbuster ? "üö® BLOCKBUSTER TRADE!" : "‚úÖ TRADE ACCEPTED",
      sub: `${other} agreed to your offer.`,
      badgeObj: badge,
      youGiveItems: youGive,
      theyGiveItems: theyGive,
      eval1: net>0 ? `Net: You WIN by ${net}` : net<0 ? `Net: You LOSE by ${Math.abs(net)}` : "Net: EVEN",
      eval2: `Menu Power: ${powerOf(S.my)}`,
      buttonsHTML: `<button class="btnGood" onclick="closeModal()">Nice</button>`
    });

    logLine(`Accepted by ${other}.`);
    S.giveYou=[]; S.giveThey=[];
    render();
    return;
  }

  if(decision==="rejected"){
    fxStatus("rejected", false);
    openModal({
      title: "‚ùå TRADE REJECTED",
      sub: `${other} declined your offer.`,
      badgeObj: badge,
      youGiveItems: youGive,
      theyGiveItems: theyGive,
      eval1: `Net: ${net>0?`WIN ${net}`:net<0?`LOSE ${Math.abs(net)}`:"EVEN"}`,
      eval2: `Menu Power: ${powerOf(S.my)}`,
      buttonsHTML: `<button class="btnBad" onclick="closeModal()">Oof</button>`
    });
    logLine(`Rejected by ${other}.`);
    return;
  }

  // counter (simple)
  fxStatus("countered", false);
  openModal({
    title: "üîÅ COUNTEROFFER!",
    sub: `${other} wants a better deal. Try adjusting your offer.`,
    badgeObj: badge,
    youGiveItems: youGive,
    theyGiveItems: theyGive,
    eval1: `Net: ${net>0?`WIN ${net}`:net<0?`LOSE ${Math.abs(net)}`:"EVEN"}`,
    eval2: `Tip: offer slightly more value.`,
    buttonsHTML: `<button class="btnPink" onclick="closeModal()">Okay</button>`
  });
  logLine(`Countered by ${other}.`);
}

function endTurn(){
  if(!S.started) return;
  if(S.turn >= 10){
    const p = powerOf(S.my);
    if(p >= S.goal){
      showBanner("üèÜ YOU BUILT THE GOAT MENU!", "#6ef3b2", true);
      startConfetti(2200, 220);
    }else{
      showBanner("‚è≥ RUN OVER ‚Äî TRY AGAIN", "#ff7c7c", true);
    }
    return;
  }
  S.turn++;
  S.tradesLeft = S.tradesPerTurn;
  S.giveYou=[]; S.giveThey=[];
  $("send").disabled = false;
$("send").style.opacity = 1;

  logLine(`Turn ${S.turn} begins. New inbox offers arrived.`);
  generateInbox();
  render();
}

/* Inbox actions */
function selectedOffer(){
  return S.inbox.find(o=>o.id===S.inboxSel) || null;
}
function acceptOffer(){
  const off = selectedOffer();
  if(!off) return;
  // fromTeam gives you giveYou, you give them giveThey
  const other = off.fromTeam;
  const youGet = off.giveYou;   // receive
  const youGive = off.giveThey; // give
  const blockbuster = isBlockbuster(youGive, youGet);
  executeTrade(other, youGive, youGet);
  fxStatus("accepted", blockbuster);
  logLine(`Accepted inbox offer from ${other}.`);
  S.inbox = S.inbox.filter(x=>x.id!==off.id);
  S.inboxSel = S.inbox[0]?.id || null;
  render();
}
function rejectOffer(){
  const off = selectedOffer();
  if(!off) return;
  fxStatus("rejected", false);
  logLine(`Rejected inbox offer from ${off.fromTeam}.`);
  S.inbox = S.inbox.filter(x=>x.id!==off.id);
  S.inboxSel = S.inbox[0]?.id || null;
  render();
}
function counterOffer(){
  const off = selectedOffer();
  if(!off) return;
  fxStatus("countered", false);
  logLine(`Countered ${off.fromTeam}. (Make a new offer in Make Offer tab)`);
  setTab("make");
  render();
}

/* ================= INIT (THIS IS THE KEY) ================= */
function init(){
  // populate team dropdowns
  const teams = Object.keys(DATA_SEED);

  const my = $("myTeam");
  my.innerHTML="";
  for(const t of teams){
    const o=document.createElement("option");
    o.value=t; o.textContent=t;
    my.appendChild(o);
  }

  const target = $("target");
  target.innerHTML="";
  for(const t of teams){
    const o=document.createElement("option");
    o.value=t; o.textContent=t;
    target.appendChild(o);
  }

  // button wiring
  $("startBtn").onclick = startRun;
  $("newRun").onclick = ()=>location.reload();
  $("endTurn").onclick = endTurn;
  $("send").onclick = sendOffer;

  $("clearProposal").onclick = ()=>{
    S.giveYou=[]; S.giveThey=[];
    logLine("üßº Cleared proposal.");
    render();
  };

  $("tInbox").onclick = ()=>{ setTab("inbox"); render(); };
  $("tMake").onclick = ()=>{ setTab("make"); render(); };

  $("accept").onclick = acceptOffer;
  $("reject").onclick = rejectOffer;
  $("counter").onclick = counterOffer;

  // target change should update right menu instantly
  $("target").addEventListener("change", ()=>{
    if(S.started && S.tab==="make") render();
  });

  // drop zones
  wireDrop($("giveYou"), (p)=>{
    if(!S.started || S.tab!=="make") return;
    if(p.team!==S.my) return;
    if(p.item && !S.giveYou.some(x=>x.name===p.item.name)) S.giveYou.push(p.item);
    render();
  });

  wireDrop($("giveThey"), (p)=>{
    if(!S.started || S.tab!=="make") return;
    const tgt = $("target").value;
    if(p.team!==tgt) return;
    if(p.item && !S.giveThey.some(x=>x.name===p.item.name)) S.giveThey.push(p.item);
    render();
  });

  // default tab
  setTab("make");
  renderStats();
  logLine("Loaded. Pick your chain and press Start Run.");
}

window.addEventListener("DOMContentLoaded", init);

</script>

</body>
</html>
