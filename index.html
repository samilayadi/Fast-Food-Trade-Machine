<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fast Food CEO Trade Machine</title>

<style>
  :root{
    --bg:#070a12; --panel:#0f1629; --panel2:#0b1020;
    --ink:#e8eefc; --muted:#b8c5e6; --line:#233055;
    --good:#6ef3b2; --bad:#ff7c7c; --warn:#ffd27c; --hot:#ff8bd3;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  html, body { height:100%; }
  body{
    margin:0; color:var(--ink);
    background:linear-gradient(180deg,#070a12,#0b0f19);
    overflow:hidden;
  }

  header{
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    background:rgba(15,22,41,.95);
    position:sticky; top:0; z-index:10;
  }
  header h1{ margin:0; font-size:18px; }
  header p{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35; }

  .wrap{
    max-width:1200px;
    margin:0 auto;
    height: calc(100vh - 72px);
    padding:10px 12px 12px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    box-sizing:border-box;
    gap:10px;
  }

  .card{
    background:rgba(15,22,41,.92);
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
    box-sizing:border-box;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .muted{ color:var(--muted); font-size:12px; }
  .small{ font-size:11px; color:var(--muted); }

  select,button{
    background:var(--panel2); color:var(--ink);
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px 10px;
    font-size:14px;
  }
  button{ cursor:pointer; font-weight:950; background:#1e2a4d; }
  button:hover{ filter:brightness(1.06); }
  button.good{ background:#153a2a; border-color:#2a664a; }
  button.danger{ background:#3a1b2a; border-color:#5a2741; }
  button.hot{ background:#3a1432; border-color:#6b2a5f; }
  button.ghost{ background:transparent; border:1px dashed var(--line); color:var(--muted); }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  /* HUD */
  .hud{
    display:grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap:10px;
  }
  @media(max-width:980px){ .hud{ grid-template-columns:1fr 1fr; } }

  .hudBox{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(11,16,32,.7);
    padding:10px;
  }
  .hudBox .k{ font-size:12px; color:var(--muted); }
  .hudBox .v{ font-size:22px; font-weight:950; margin-top:4px; font-variant-numeric:tabular-nums; }
  .hudBox .s{ font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35; }

  /* Tabs */
  .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
  .tab{
    padding:9px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(11,16,32,.6);
    cursor:pointer;
    font-weight:950;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .tab.active{ outline:2px solid rgba(110,243,178,.45); }
  .tabIcon{ font-size:14px; }

  #viewInbox, #viewMake{
    flex:1; min-height:0; overflow:hidden;
    display:flex; flex-direction:column;
    gap:10px;
  }

  /* ===== 3-column make layout (FIXED so center won't squeeze right menu off-screen) ===== */
  .make3{
    flex:1;
    min-height:0;
    overflow:hidden;
    display:grid;
    grid-template-columns: minmax(280px, 1fr) minmax(420px, 1.15fr) minmax(280px, 1fr);
    gap:12px;
    align-items:stretch;
  }
  .makeCol{
    min-height:0;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .colHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }

  .logoSlot{
    width:48px; height:48px;
    border-radius:16px;
    border:1px dashed rgba(184,197,230,.35);
    display:flex; align-items:center; justify-content:center;
    background:rgba(15,22,41,.55);
    color:var(--muted);
    font-weight:950;
    font-size:11px;
    overflow:hidden;
    flex:0 0 auto;
  }
  .logoSlot img{ width:100%; height:100%; object-fit:contain; display:block; padding:7px; }

  /* ===== GRID MENU TILES ===== */
  .rosterGrid{
    flex:1;
    min-height:0;
    overflow:auto;
    padding-right:6px;
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:10px;
  }
  @media(max-width:1100px){
    .rosterGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }

  .tile{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(11,16,32,.78);
    padding:10px;
    user-select:none;
    cursor:grab;
    display:flex;
    flex-direction:column;
    gap:8px;
    aspect-ratio: 1 / 1;
  }
  .tile:active{ cursor:grabbing; }

  .thumb{
    width:100%;
    border-radius:14px;
    border:1px solid var(--line);
    overflow:hidden;
    background:var(--panel2);
    flex:1;
    min-height:0;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

  .tBottom{
    display:flex;
    align-items:flex-start;
    gap:8px;
  }
  .tName{
    font-weight:950;
    font-size:12px;
    line-height:1.2;
    min-width:0;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .tTags{
    font-size:10px;
    color:var(--muted);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    margin-top:3px;
  }
  .tVal{
    margin-left:auto;
    font-weight:950;
    font-size:12px;
    font-variant-numeric:tabular-nums;
    color:rgba(232,238,252,.92);
  }

  .divider{ height:1px; background:#1d2740; }

  /* Middle outgoing builder */
  .midCenter{
    min-height:0; overflow:hidden;
    display:flex; flex-direction:column;
    gap:10px;
  }

  .logoBridge{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .logoPuck{
    width:44px; height:44px;
    border-radius:999px;
    border:1px solid rgba(184,197,230,.25);
    background:rgba(15,22,41,.65);
    display:flex; align-items:center; justify-content:center;
    font-weight:950;
    color:var(--muted);
    font-size:11px;
    overflow:hidden;
    flex:0 0 auto;
  }
  .logoPuck img{ width:100%; height:100%; object-fit:contain; display:block; padding:9px; }
  .logoArrow{ font-weight:950; color:rgba(184,197,230,.75); font-size:18px; }

  .midSplit2{
    flex:1;
    min-height:0;
    overflow:hidden;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .dropWrap{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(11,16,32,.55);
    padding:10px;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .dropZone{
    flex:1;
    min-height:0;
    overflow:auto;
    border:2px dashed rgba(184,197,230,.18);
    border-radius:16px;
    padding:10px;
    display:grid; /* KEY: grid tiles, not stacked list */
    grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
    gap:10px;
    align-content:start;
  }
  .dropZone.dragover{ border-color: var(--good); background: rgba(110,243,178,.06); }

  /* ===== Package tiles (BIGGER + Remove always visible) ===== */
  .pkgCard{
    position:relative;
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(15,22,41,.92);
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height: 180px;
  }
  .mini{
    width:100%;
    height: 120px;
    border-radius:14px;
    overflow:hidden;
    border:1px solid var(--line);
    background:var(--panel2);
  }
  .mini img{ width:100%; height:100%; object-fit:cover; display:block; }
  .pkgMeta b{
    font-size:12px;
    display:block;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .pkgMeta span{ font-size:11px; color:var(--muted); display:block; margin-top:4px; }

  .rmBtn{
    position:absolute;
    top:8px; right:8px;
    padding:6px 8px;
    border-radius:12px;
    background:rgba(10,14,24,.75);
    border:1px solid rgba(184,197,230,.25);
    color:var(--ink);
    font-size:11px;
    cursor:pointer;
  }
  .rmBtn:hover{ filter:brightness(1.08); }

  /* ===== INBOX shows big images + names ===== */
  .offerList{
    flex:1;
    min-height:0;
    overflow:auto;
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap:10px;
    padding-right:6px;
  }
  @media(max-width:980px){ .offerList{ grid-template-columns:1fr; } }

  .offerCard{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(11,16,32,.55);
    padding:10px;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .offerCard:hover{ filter:brightness(1.06); }
  .offerCard.selected{ outline:2px solid rgba(110,243,178,.45); }

  .offerTop{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
  }
  .offerTitle{ font-weight:950; font-size:13px; }
  .offerSub{ color:var(--muted); font-size:11px; margin-top:2px; }

  .offerSplit{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .offerBox{
    border:1px solid rgba(184,197,230,.16);
    border-radius:14px;
    padding:10px;
    background:rgba(15,22,41,.35);
    min-height:140px;
  }
  .offerBox .lbl{ font-size:10px; color:var(--muted); font-weight:950; margin-bottom:8px; }

  .bigRow{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .bigItem{
    display:flex;
    gap:10px;
    align-items:center;
    border:1px solid rgba(184,197,230,.14);
    border-radius:14px;
    padding:8px;
    background:rgba(10,14,24,.35);
  }
  .bigThumb{
    width:74px; height:74px;
    border-radius:14px;
    overflow:hidden;
    border:1px solid rgba(184,197,230,.22);
    background:rgba(11,16,32,.7);
    flex:0 0 auto;
  }
  .bigThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .bigName{
    font-weight:950;
    font-size:12px;
    line-height:1.2;
  }
  .bigVal{
    margin-top:4px;
    font-size:11px;
    color:var(--muted);
    font-variant-numeric:tabular-nums;
  }

  .badge{
    display:inline-block;
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid var(--line);
    font-weight:950;
    white-space:nowrap;
  }
  .bF{ color:var(--bad); border-color: rgba(255,124,124,.45); background: rgba(255,124,124,.08); }
  .bR{ color:var(--good); border-color: rgba(110,243,178,.45); background: rgba(110,243,178,.07); }
  .bB{ color:var(--hot); border-color: rgba(255,139,211,.45); background: rgba(255,139,211,.08); }

  .log{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(11,16,32,.55);
    padding:10px;
    max-height: 78px;
    overflow:auto;
    font-size:12px;
    color:var(--muted);
    line-height:1.45;
  }
  .log b{ color:var(--ink); }

  /* FX Layer */
  #fxLayer{ position:fixed; inset:0; pointer-events:none; z-index:9999; }
  #tradeBanner{
    position:absolute; left:50%; top:12%;
    transform:translateX(-50%) translateY(-20px);
    opacity:0;
    padding:14px 18px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(10,14,24,.82);
    backdrop-filter: blur(10px);
    box-shadow:0 18px 45px rgba(0,0,0,.55);
    font:900 18px/1.1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    letter-spacing:.4px;
    white-space:nowrap;
  }
  #confettiCanvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
  }

  /* Modal */
  #modalMask{
    position:fixed; inset:0; z-index:9998;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
  }
  .modal{
    width:min(880px, 96vw);
    max-height: min(720px, 90vh);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(10,14,24,.92);
    box-shadow:0 24px 70px rgba(0,0,0,.65);
  }
  .modalHead{
    padding:14px 14px 10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .modalTitle{ font-weight:950; font-size:16px; }
  .modalBody{
    padding:14px;
    overflow:auto;
    min-height:0;
  }
  .modalGrid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
  }
  .modalFoot{
    padding:12px 14px 14px;
    display:flex;
    justify-content:flex-end;
    gap:10px;
    border-top:1px solid rgba(255,255,255,.08);
  }

  @media(max-width:980px){
    body{ overflow:auto; }
    .wrap{ height:auto; overflow:visible; }
  }
</style>
</head>

<body>
<header>
  <h1>üçî Fast Food CEO Trade Machine</h1>
  <p>Cleaner center packages + inbox shows full offers + blockbuster confetti.</p>
</header>

<div class="wrap">

  <!-- START -->
  <div class="card" id="startCard">
    <div class="row" style="justify-content:flex-start;">
      <div style="font-weight:950;">Choose your CEO</div>
      <span class="muted">Needs placeholder image: <b>assets/items/placeholder.jpg</b></span>
    </div>
    <div class="row" style="margin-top:10px; justify-content:flex-start;">
      <label class="muted">My Chain</label>
      <select id="myTeam"></select>

      <label class="muted">Fairness</label>
      <select id="fairness">
        <option value="6">¬±6 strict</option>
        <option value="8" selected>¬±8 normal</option>
        <option value="12">¬±12 loose</option>
      </select>

      <button class="good" id="startBtn">Start Run</button>
    </div>
    <div class="small" style="margin-top:10px;">
      Tip: logos in <b>assets/logos/</b> (mcdonalds.png, tacobell.png, etc.). If missing, it falls back to text.
    </div>
  </div>

  <!-- GAME -->
  <div id="gameShell" style="display:none; flex:1; min-height:0; overflow:hidden; display:flex; flex-direction:column; gap:10px;">

    <div class="row">
      <div class="row" style="justify-content:flex-start;">
        <button class="ghost" id="clearProposal">Clear Proposal</button>
        <button class="danger" id="newRun">New Run</button>
      </div>
      <div class="row" style="justify-content:flex-end;">
        <button class="hot" id="endTurn">End Turn ‚ûú</button>
      </div>
    </div>

    <div class="hud">
      <div class="hudBox">
        <div class="k">You are CEO of</div>
        <div class="v" id="hudTeam">‚Äî</div>
        <div class="s">Goal: <b id="goalTxt">650</b> Power by Turn 10</div>
      </div>
      <div class="hudBox">
        <div class="k">Turn</div>
        <div class="v" id="hudTurn">1 / 10</div>
        <div class="s" id="hudInbox">Inbox offers: 3</div>
      </div>
      <div class="hudBox">
        <div class="k">Menu Power</div>
        <div class="v" id="hudPower">0</div>
        <div class="s" id="hudPowerNote">Trade to improve your menu.</div>
      </div>
      <div class="hudBox">
        <div class="k">Reputation</div>
        <div class="v" id="hudRep">50</div>
        <div class="s" id="hudRepNote">Neutral üòê</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabInbox"><span class="tabIcon">üì•</span>Inbox</div>
      <div class="tab" id="tabMake"><span class="tabIcon">üì§</span>Make Offer</div>
    </div>

    <!-- INBOX VIEW -->
    <div class="card" id="viewInbox">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:950;" id="inTitle">Incoming offers</div>
          <div class="muted" id="inMsg">Pick one to inspect.</div>
        </div>
        <div class="row">
          <span class="badge bR" id="inBadge" style="display:none;">FAIR</span>
          <button class="good" id="btnAccept" disabled>Accept</button>
          <button class="ghost" id="btnCounter" disabled>Counter</button>
          <button class="danger" id="btnReject" disabled>Reject</button>
        </div>
      </div>

      <div class="offerList" id="offerList"></div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:950;" id="inEval">‚Äî</div>
        <div class="muted" id="inEval2">‚Äî</div>
      </div>
    </div>

    <!-- MAKE OFFER VIEW -->
    <div class="card" id="viewMake" style="display:none;">

      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:950;">Trade Center (Outgoing Offer)</div>
          <div class="muted">Drag from the grid menus into the center.</div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <label class="muted">Target CEO</label>
          <select id="targetTeam"></select>
          <button class="good" id="btnSend">Send Offer</button>
        </div>
      </div>

      <div class="make3">

        <!-- LEFT -->
        <div class="makeCol">
          <div class="colHeader">
            <div>
              <div style="font-weight:950;">Your Menu</div>
              <div class="muted" id="myCount">‚Äî</div>
            </div>
            <div class="logoSlot" id="logoLeftSlot">YOU</div>
          </div>
          <div class="rosterGrid" id="myRoster"></div>
        </div>

        <!-- MIDDLE -->
        <div class="makeCol midCenter">
          <div>
            <div style="font-weight:950;">Outgoing Offer</div>
            <div class="muted">Drop into both boxes, then Send.</div>
          </div>

          <div class="logoBridge">
            <div class="logoPuck" id="logoLeftPuck">YOU</div>
            <div class="logoArrow">‚áÑ</div>
            <div class="logoPuck" id="logoRightPuck">THEM</div>
          </div>

          <div class="midSplit2">
            <div class="dropWrap">
              <div class="muted" style="font-weight:950;">You give</div>
              <div class="dropZone" id="pkgYou"></div>
            </div>
            <div class="dropWrap">
              <div class="muted" style="font-weight:950;">They give</div>
              <div class="dropZone" id="pkgThey"></div>
            </div>
          </div>

          <div class="divider"></div>
          <div style="font-weight:950;" id="mkEval">Build a proposal</div>
          <div class="muted" id="mkEval2">Drag items into both packages.</div>
        </div>

        <!-- RIGHT -->
        <div class="makeCol">
          <div class="colHeader">
            <div>
              <div style="font-weight:950;">Target Menu</div>
              <div class="muted" id="themCount">‚Äî</div>
            </div>
            <div class="logoSlot" id="logoRightSlot">THEM</div>
          </div>
          <div class="rosterGrid" id="themRoster"></div>
        </div>

      </div>
    </div>

    <div class="log" id="log"></div>
  </div>
</div>

<div id="fxLayer">
  <canvas id="confettiCanvas"></canvas>
  <div id="tradeBanner"></div>
</div>

<!-- MODAL -->
<div id="modalMask">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle" id="mTitle">Trade Result</div>
        <div class="muted" id="mSub">‚Äî</div>
      </div>
      <div class="badge bR" id="mBadge" style="display:none;">FAIR</div>
    </div>
    <div class="modalBody">
      <div class="modalGrid">
        <div>
          <div class="muted" style="font-weight:950; margin-bottom:6px;">You give</div>
          <div class="dropWrap"><div class="dropZone" id="mYou"></div></div>
        </div>
        <div>
          <div class="muted" style="font-weight:950; margin-bottom:6px;">They give</div>
          <div class="dropWrap"><div class="dropZone" id="mThey"></div></div>
        </div>
      </div>
      <div class="divider" style="margin:12px 0;"></div>
      <div style="font-weight:950;" id="mEval">‚Äî</div>
      <div class="muted" id="mEval2">‚Äî</div>
    </div>
    <div class="modalFoot" id="mButtons">
      <button class="ghost" id="mClose">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Trade Machine
========================= */

const PLACEHOLDER = "assets/items/placeholder.jpg";

/* ===== Data ===== */
const DATA_SEED = {
  "McDonald's":[
    {name:"Big Mac",base:86,tags:["iconic"],img:"assets/items/big-mac.jpg"},
    {name:"Fries",base:80,tags:["iconic","speed"],img:"assets/items/mcd-fries.jpg"},
    {name:"Nuggets (10pc)",base:78,tags:["iconic"],img:"assets/items/nuggets.jpg"},
    {name:"McFlurry",base:74,tags:["broken"],img:"assets/items/mcflurry.jpg"},
    {name:"Egg McMuffin",base:76,tags:["iconic"],img:"assets/items/egg-mcmuffin.jpg"},
    {name:"Hash Browns",base:70,tags:["speed"],img:"assets/items/hash-browns.jpg"},
    {name:"Filet-O-Fish",base:72,tags:["iconic"],img:"assets/items/filet-o-fish.jpg"}
  ],
  "Taco Bell":[
    {name:"Baja Blast",base:90,tags:["iconic"],img:"assets/items/baja-blast.jpg"},
    {name:"Crunchwrap Supreme",base:88,tags:["iconic"],img:"assets/items/crunchwrap.jpg"},
    {name:"Doritos Locos Taco",base:84,tags:["iconic"],img:"assets/items/doritos-locos.jpg"},
    {name:"Quesadilla",base:80,tags:["iconic"],img:"assets/items/tb-quesadilla.jpg"},
    {name:"Nacho Fries (LTO)",base:83,tags:["lto"],img:"assets/items/nacho-fries.jpg"},
    {name:"Fire Sauce",base:64,tags:["sauce"],img:"assets/items/fire-sauce.jpg"},
    {name:"Cinnamon Twists",base:70,tags:["dessert"],img:"assets/items/cinnamon-twists.jpg"}
  ],
  "Chick-fil-A":[
    {name:"Chicken Sandwich",base:90,tags:["iconic"],img:"assets/items/chicken-sandwich.jpg"},
    {name:"Spicy Chicken Sandwich",base:92,tags:["iconic"],img:"assets/items/spicy-chicken-sandwich.jpg"},
    {name:"Waffle Fries",base:86,tags:["iconic","speed"],img:"assets/items/waffle-fries.jpg"},
    {name:"Nuggets (12ct)",base:82,tags:["iconic"],img:"assets/items/cfa-nuggets.jpg"},
    {name:"Chick-fil-A Sauce",base:66,tags:["sauce"],img:"assets/items/cfa-sauce.jpg"},
    {name:"Lemonade",base:75,tags:["iconic"],img:"assets/items/cfa-lemonade.jpg"},
    {name:"Mac & Cheese",base:74,tags:["iconic"],img:"assets/items/mac-and-cheese.jpg"}
  ],
  "Raising Cane's":[
    {name:"Box Combo",base:88,tags:["iconic"],img:"assets/items/box-combo.jpg"},
    {name:"Chicken Fingers",base:86,tags:["iconic"],img:"assets/items/chicken-fingers.jpg"},
    {name:"Cane's Sauce",base:70,tags:["sauce","iconic"],img:"assets/items/canes-sauce.jpg"},
    {name:"Texas Toast",base:76,tags:["iconic"],img:"assets/items/texas-toast.jpg"},
    {name:"Crinkle Fries",base:80,tags:["speed"],img:"assets/items/crinkle-fries.jpg"},
    {name:"Lemonade",base:74,tags:["iconic"],img:"assets/items/rc-lemonade.jpg"},
    {name:"Coleslaw",base:66,tags:[],img:"assets/items/coleslaw.jpg"}
  ],
  "Burger King":[
    {name:"Whopper",base:84,tags:["iconic"],img:"assets/items/whopper.jpg"},
    {name:"Fries",base:76,tags:["speed"],img:"assets/items/bk-fries.jpg"},
    {name:"Onion Rings",base:73,tags:["iconic"],img:"assets/items/onion-rings.jpg"},
    {name:"Chicken Fries",base:76,tags:["iconic"],img:"assets/items/chicken-fries.jpg"},
    {name:"Impossible Whopper (LTO)",base:78,tags:["lto"],img:"assets/items/impossible-whopper.jpg"},
    {name:"Croissan'wich",base:72,tags:["iconic"],img:"assets/items/croissanwich.jpg"},
    {name:"Chocolate Pie",base:70,tags:["dessert"],img:"assets/items/chocolate-pie.jpg"}
  ],
  "Chipotle":[
    {name:"Burrito",base:86,tags:["iconic"],img:"assets/items/burrito.jpg"},
    {name:"Bowl",base:86,tags:["iconic"],img:"assets/items/bowl.jpg"},
    {name:"Chips & Guac",base:80,tags:["upgrade","iconic"],img:"assets/items/chips-guac.jpg"},
    {name:"Queso",base:74,tags:["upgrade"],img:"assets/items/queso.jpg"},
    {name:"Barbacoa",base:82,tags:["iconic"],img:"assets/items/barbacoa.jpg"},
    {name:"Vinaigrette",base:64,tags:["sauce"],img:"assets/items/vinaigrette.jpg"},
    {name:"Hot Salsa",base:64,tags:["sauce"],img:"assets/items/hot-salsa.jpg"}
  ],
  "Panda Express":[
    {name:"Orange Chicken",base:90,tags:["iconic"],img:"assets/items/orange-chicken.jpg"},
    {name:"Chow Mein",base:82,tags:["iconic"],img:"assets/items/chow-mein.jpg"},
    {name:"Fried Rice",base:80,tags:["iconic"],img:"assets/items/fried-rice.jpg"},
    {name:"Beijing Beef",base:84,tags:["iconic"],img:"assets/items/beijing-beef.jpg"},
    {name:"Walnut Shrimp (LTO)",base:86,tags:["lto"],img:"assets/items/walnut-shrimp.jpg"},
    {name:"Super Greens",base:70,tags:[],img:"assets/items/super-greens.jpg"},
    {name:"Fortune Cookie",base:62,tags:["nostalgia"],img:"assets/items/fortune-cookie.jpg"}
  ],
  "Subway":[
    {name:"Footlong Sub",base:80,tags:["iconic"],img:"assets/items/footlong-sub.jpg"},
    {name:"Italian B.M.T.",base:82,tags:["iconic"],img:"assets/items/italian-bmt.jpg"},
    {name:"Meatball Marinara",base:80,tags:["iconic"],img:"assets/items/meatball.jpg"},
    {name:"Tuna Sub",base:74,tags:["iconic"],img:"assets/items/tuna-sub.jpg"},
    {name:"Cookies",base:70,tags:["dessert"],img:"assets/items/subway-cookies.jpg"},
    {name:"Southwest Sauce",base:64,tags:["sauce"],img:"assets/items/subway-southwest.jpg"},
    {name:"Soft Pretzel (LTO)",base:72,tags:["lto"],img:"assets/items/soft-pretzel.jpg"}
  ],
  "Domino's":[
    {name:"Pepperoni Pizza",base:90,tags:["iconic"],img:"assets/items/pepperoni-pizza.jpg"},
    {name:"Cheesy Bread",base:82,tags:["iconic"],img:"assets/items/cheesy-bread.jpg"},
    {name:"Wings",base:84,tags:["iconic"],img:"assets/items/wings.jpg"},
    {name:"Cinnamon Twists",base:74,tags:["dessert"],img:"assets/items/dom-cinnamon.jpg"},
    {name:"Lava Cake",base:78,tags:["dessert","iconic"],img:"assets/items/lava-cake.jpg"},
    {name:"Garlic Dip",base:64,tags:["sauce"],img:"assets/items/garlic-dip.jpg"},
    {name:"Stuffed Crust (LTO)",base:82,tags:["lto"],img:"assets/items/stuffed-crust.jpg"}
  ],
  "Wendy's":[
    {name:"Baconator",base:88,tags:["iconic"],img:"assets/items/baconator.jpg"},
    {name:"Dave's Single",base:82,tags:["iconic"],img:"assets/items/daves-single.jpg"},
    {name:"Spicy Nuggets",base:83,tags:["iconic"],img:"assets/items/spicy-nuggets.jpg"},
    {name:"Spicy Chicken Sandwich",base:84,tags:["iconic"],img:"assets/items/wendys-spicy-chicken.jpg"},
    {name:"Fries",base:76,tags:["speed"],img:"assets/items/wendys-fries.jpg"},
    {name:"Frosty",base:80,tags:["iconic"],img:"assets/items/frosty.jpg"},
    {name:"Chili",base:72,tags:["iconic"],img:"assets/items/chili.jpg"}
  ]
};

const BONUS = { sauce:6, lto:8, iconic:5, broken:-7, speed:3, upgrade:4, dessert:2, nostalgia:2 };

const PERSONALITY = {
  "McDonald's":{stingy:0.75, block:0.10},
  "Taco Bell":{stingy:0.45, block:0.22},
  "Chick-fil-A":{stingy:0.60, block:0.14},
  "Raising Cane's":{stingy:0.55, block:0.12},
  "Burger King":{stingy:0.50, block:0.15},
  "Chipotle":{stingy:0.70, block:0.12},
  "Panda Express":{stingy:0.62, block:0.13},
  "Subway":{stingy:0.52, block:0.10},
  "Domino's":{stingy:0.45, block:0.20},
  "Wendy's":{stingy:0.55, block:0.14}
};

const $ = (id)=>document.getElementById(id);
const clone = (x)=>JSON.parse(JSON.stringify(x));
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const esc = (s)=>(s+"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

function imgHTML(src, alt){
  const safe = src || PLACEHOLDER;
  return `<img src="${safe}" alt="${esc(alt)}" loading="lazy"
    onerror="this.onerror=null;this.src='${PLACEHOLDER}';">`;
}

/* ===== State ===== */
let S = {
  DATA: clone(DATA_SEED),
  my: null,
  turn: 1,
  maxTurns: 10,
  targetPower: 650,
  rep: 50,
  fairness: 8,
  tab: "inbox",
  inbox: [],
  selectedOfferId: null,
  pkgYou: [],
  pkgThey: [],
  pendingCounter: null
};

function roster(team){ return S.DATA[team] || []; }

function itemValue(it){
  if(!it) return 0;
  let v = it.base;
  for(const t of (it.tags||[])) if(BONUS[t]!=null) v += BONUS[t];
  return v;
}
function power(team){ return roster(team).reduce((a,it)=>a+itemValue(it),0); }
function findItem(team, name){ return roster(team).find(x=>x.name===name) || null; }
function sumNames(team, names){
  let total=0;
  const r=roster(team);
  for(const n of names){
    const it=r.find(x=>x.name===n);
    if(it) total+=itemValue(it);
  }
  return total;
}
function youNet(other, youGive, theyGive){
  const give=sumNames(S.my, youGive);
  const get=sumNames(other, theyGive);
  return {give, get, diff:(get-give)};
}
function theirVerdict(other, youGive, theyGive){
  const p = PERSONALITY[other] || {stingy:0.55, block:0.12};
  const received = sumNames(S.my, youGive);
  const given    = sumNames(other, theyGive);
  const score = received - given;

  const repPenalty = (S.rep < 35) ? 6 : (S.rep < 50) ? 3 : 0;
  const stingyNeed = Math.round((p.stingy - 0.50) * 14);
  const acceptThresh = -Math.floor(S.fairness/2) + stingyNeed + repPenalty;
  const counterThresh = -Math.floor(S.fairness*1.7) + stingyNeed + repPenalty;

  let verdict = "reject";
  if(score >= acceptThresh) verdict = "accept";
  else if(score >= counterThresh) verdict = "counter";
  return {score, verdict, acceptThresh};
}

/* ===== BLOCKBUSTER CHECK ===== */
function isBlockbuster(other, youGive, theyGive){
  let hi=0;
  for(const n of youGive){
    const it = findItem(S.my, n);
    if(itemValue(it) >= 89) hi++;
  }
  for(const n of theyGive){
    const it = findItem(other, n);
    if(itemValue(it) >= 89) hi++;
  }
  return hi >= 2;
}

/* FX Banner + Shake */
(function setupFX(){
  const style = document.createElement("style");
  style.textContent = `
    @keyframes bannerIn {
      0% { opacity:0; transform:translateX(-50%) translateY(-22px) scale(.96); filter:blur(2px); }
      20%{ opacity:1; transform:translateX(-50%) translateY(0px) scale(1); filter:blur(0px); }
      80%{ opacity:1; transform:translateX(-50%) translateY(0px) scale(1); }
      100%{ opacity:0; transform:translateX(-50%) translateY(-14px) scale(.985); }
    }
    @keyframes screenShake {
      0%{ transform:translate(0,0); }
      20%{ transform:translate(7px,-5px); }
      40%{ transform:translate(-7px,4px); }
      60%{ transform:translate(6px,5px); }
      80%{ transform:translate(-5px,-4px); }
      100%{ transform:translate(0,0); }
    }
  `;
  document.head.appendChild(style);
})();

function showBanner(text, color, shake=false){
  const banner = $("tradeBanner");
  banner.textContent = text;
  banner.style.color = color;
  banner.style.animation = "none";
  banner.offsetHeight;
  banner.style.animation = "bannerIn 1400ms ease-out forwards";
  if(shake){
    document.body.style.animation="none";
    document.body.offsetHeight;
    document.body.style.animation="screenShake 520ms ease-in-out";
  }
}

/* ===== CONFETTI ===== */
let confettiRunning=false;
function resizeConfetti(){
  const c = $("confettiCanvas");
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  c.width = Math.floor(window.innerWidth * dpr);
  c.height = Math.floor(window.innerHeight * dpr);
}
window.addEventListener("resize", resizeConfetti);

function startConfetti(durationMs=1600, count=160){
  if(confettiRunning) return;
  confettiRunning=true;

  resizeConfetti();
  const c = $("confettiCanvas");
  const ctx = c.getContext("2d");
  const dpr = Math.max(1, window.devicePixelRatio || 1);

  const W = c.width, H = c.height;
  const parts = [];
  for(let i=0;i<count;i++){
    parts.push({
      x: Math.random()*W,
      y: -Math.random()*H*0.6,
      vx: (Math.random()*2-1) * 2.2 * dpr,
      vy: (Math.random()*2+2.8) * 2.8 * dpr,
      s: (Math.random()*6+6) * dpr,
      r: Math.random()*Math.PI,
      vr:(Math.random()*2-1)*0.12,
      a: 0.9
    });
  }

  const t0 = performance.now();
  function tick(t){
    const dt = (t - t0);
    ctx.clearRect(0,0,W,H);

    for(const p of parts){
      p.x += p.vx;
      p.y += p.vy;
      p.r += p.vr;
      p.vy += 0.04 * dpr; // gravity
      p.vx *= 0.995;

      // simple wrap
      if(p.x < -40*dpr) p.x = W+40*dpr;
      if(p.x > W+40*dpr) p.x = -40*dpr;

      // fade near end
      const fade = 1 - (dt / durationMs);
      p.a = Math.max(0, Math.min(0.9, fade));

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x,p.y);
      ctx.rotate(p.r);
      // no fixed colors: use random-ish via HSL
      ctx.fillStyle = `hsl(${Math.floor((p.x/W)*360)}, 90%, 60%)`;
      ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s*0.65);
      ctx.restore();
    }

    if(dt < durationMs){
      requestAnimationFrame(tick);
    } else {
      ctx.clearRect(0,0,W,H);
      confettiRunning=false;
    }
  }
  requestAnimationFrame(tick);
}

function fxStatus(status, blockbuster=false){
  if(blockbuster){
    showBanner("üö® BLOCKBUSTER TRADE!", "#ff8bd3", true);
    startConfetti(1800, 180);
    return;
  }
  if(status==="accepted") showBanner("‚úÖ TRADE ACCEPTED", "#6ef3b2", false);
  if(status==="countered") showBanner("üîÅ COUNTEROFFER!", "#ff8bd3", false);
  if(status==="rejected") showBanner("‚ùå TRADE REJECTED", "#ff7c7c", true);
}

/* Logos */
function teamSlug(team){ return (team||"").toLowerCase().replace(/[^a-z0-9]+/g,""); }
function logoPath(team){ return `assets/logos/${teamSlug(team)}.png`; }
function setLogo(elId, team, fallbackText){
  const el = $(elId);
  if(!el) return;
  const src = logoPath(team);
  el.innerHTML = `<img src="${src}" alt="${esc(team)}"
    onerror="this.remove(); this.parentElement.textContent='${esc(fallbackText)}';">`;
}

/* Logging */
function logLine(html){ $("log").innerHTML = `<div>${html}</div>` + $("log").innerHTML; }

/* Tabs */
function setTab(tab){
  S.tab = tab;
  $("tabInbox").classList.toggle("active", tab==="inbox");
  $("tabMake").classList.toggle("active", tab==="make");
  $("viewInbox").style.display = (tab==="inbox") ? "" : "none";
  $("viewMake").style.display  = (tab==="make")  ? "" : "none";
  render();
}

/* Inbox offers */
function badge(type){
  if(type==="block") return {txt:"BLOCKBUSTER üö®", cls:"bB"};
  if(type==="fleece") return {txt:"FLEECE üòà", cls:"bF"};
  return {txt:"FAIR ü§ù", cls:"bR"};
}
function topItems(team){
  return roster(team).slice()
    .map(it=>({name:it.name, v:itemValue(it)}))
    .sort((a,b)=>b.v-a.v);
}
function genInbox(){
  S.inbox = [];
  const others = Object.keys(S.DATA).filter(t=>t!==S.my);
  const myTop = topItems(S.my);

  for(let i=0;i<3;i++){
    const from = pick(others);
    const p = PERSONALITY[from] || {stingy:0.55, block:0.12};

    const blockChance = clamp(p.block + (S.rep>70?0.08:S.rep>60?0.04:0), 0.05, 0.35);
    const fleeceChance = clamp(0.42 + (S.rep<40?0.18:S.rep<55?0.08:-0.05), 0.15, 0.75);

    const r = Math.random();
    let type = "fair";
    if(r < blockChance) type = "block";
    else if(r < blockChance + fleeceChance) type = "fleece";

    const theirTop = topItems(from);
    let youGive=[], theyGive=[];
    if(type==="fleece"){
      youGive=[myTop[0]?.name].filter(Boolean);
      theyGive=[theirTop[theirTop.length-1]?.name].filter(Boolean);
    } else if(type==="block"){
      youGive=[myTop[0]?.name, myTop[1]?.name].filter(Boolean);
      theyGive=[theirTop[0]?.name, theirTop[1]?.name].filter(Boolean);
    } else {
      youGive=[myTop[2]?.name || myTop[0]?.name].filter(Boolean);
      theyGive=[theirTop[2]?.name || theirTop[0]?.name].filter(Boolean);
    }

    const b = badge(type);
    S.inbox.push({
      id:`o_${S.turn}_${i}_${from.replace(/\W/g,"")}_${Math.random().toString(16).slice(2)}`,
      from, type, badge:b,
      youGive, theyGive,
      msg: type==="fleece" ? "‚ÄúThis is extremely fair.‚Äù" : type==="block" ? "‚ÄúLet‚Äôs change the game.‚Äù" : "‚ÄúSolid deal.‚Äù",
      handled:false
    });
  }
  S.selectedOfferId = S.inbox[0]?.id || null;
}

/* Trading */
function executeTrade(other, youGive, theyGive){
  const myR = roster(S.my);
  const thR = roster(other);

  const myGiveItems = youGive.map(n=>findItem(S.my,n)).filter(Boolean);
  const thGiveItems = theyGive.map(n=>findItem(other,n)).filter(Boolean);

  S.DATA[S.my] = myR.filter(it=>!youGive.includes(it.name)).concat(thGiveItems);
  S.DATA[other] = thR.filter(it=>!theyGive.includes(it.name)).concat(myGiveItems);
}

/* Modal */
function closeModal(){ $("modalMask").style.display = "none"; }
function pkgCardHTML(team, name, removable){
  const it = findItem(team, name);
  const v = itemValue(it);
  const img = it?.img || PLACEHOLDER;
  return `
    <div class="pkgCard" data-name="${esc(name)}">
      <div class="mini">${imgHTML(img, name)}</div>
      <div class="pkgMeta" style="min-width:0;">
        <b title="${esc(name)}">${esc(name)}</b>
        <span>Value: ${v}</span>
      </div>
      ${removable ? `<button class="rmBtn" data-remove="1" title="Remove">Remove</button>` : ``}
    </div>
  `;
}
function openModal({title, sub, badgeObj, youGiveTeam, youGive, theyGiveTeam, theyGive, eval1, eval2, buttonsHTML}){
  $("mTitle").textContent = title;
  $("mSub").textContent = sub || "";
  const b = $("mBadge");
  if(badgeObj){
    b.style.display = "";
    b.className = `badge ${badgeObj.cls}`;
    b.textContent = badgeObj.txt;
  }else{
    b.style.display="none";
  }

  $("mYou").innerHTML = youGive.length
    ? youGive.map(n=>pkgCardHTML(youGiveTeam,n,false)).join("")
    : `<div class="muted">Nothing</div>`;
  $("mThey").innerHTML = theyGive.length
    ? theyGive.map(n=>pkgCardHTML(theyGiveTeam,n,false)).join("")
    : `<div class="muted">Nothing</div>`;

  $("mEval").textContent = eval1 || "";
  $("mEval2").textContent = eval2 || "";

  $("mButtons").innerHTML = buttonsHTML;
  $("modalMask").style.display = "flex";
}

/* Render */
function renderHUD(){
  $("hudTeam").textContent = S.my || "‚Äî";
  $("goalTxt").textContent = S.targetPower;
  $("hudTurn").textContent = `${S.turn} / ${S.maxTurns}`;
  $("hudPower").textContent = power(S.my);
  $("hudRep").textContent = S.rep;

  const pending = S.inbox.filter(o=>!o.handled).length;
  $("hudInbox").textContent = `Inbox offers: ${pending}`;

  $("hudPowerNote").textContent = (power(S.my) >= S.targetPower) ? "üèÜ Target hit!" : "Trade to improve your menu.";
  $("hudRepNote").textContent = S.rep>=60 ? "Respected üôÇ" : S.rep>=40 ? "Neutral üòê" : S.rep>=20 ? "Sketchy üòí" : "Public Enemy üò§";
}

function renderTargets(){
  const sel = $("targetTeam");
  const teams = Object.keys(S.DATA).filter(t=>t!==S.my);
  const prev = sel.value;
  sel.innerHTML = teams.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join("");
  sel.value = teams.includes(prev) ? prev : teams[0];
}

function renderOfferList(){
  const list = $("offerList");
  list.innerHTML = "";

  for(const o of S.inbox){
    const div = document.createElement("div");
    div.className = "offerCard" + (o.id===S.selectedOfferId ? " selected" : "");
    div.dataset.offerId = o.id;

    const youRows = o.youGive.map(n=>{
      const it = findItem(S.my, n);
      return `
        <div class="bigItem">
          <div class="bigThumb">${imgHTML(it?.img, n)}</div>
          <div style="min-width:0;">
            <div class="bigName" title="${esc(n)}">${esc(n)}</div>
            <div class="bigVal">Value: ${itemValue(it)}</div>
          </div>
        </div>
      `;
    }).join("") || `<div class="muted">‚Äî</div>`;

    const theyRows = o.theyGive.map(n=>{
      const it = findItem(o.from, n);
      return `
        <div class="bigItem">
          <div class="bigThumb">${imgHTML(it?.img, n)}</div>
          <div style="min-width:0;">
            <div class="bigName" title="${esc(n)}">${esc(n)}</div>
            <div class="bigVal">Value: ${itemValue(it)}</div>
          </div>
        </div>
      `;
    }).join("") || `<div class="muted">‚Äî</div>`;

    div.innerHTML = `
      <div class="offerTop">
        <div>
          <div class="offerTitle">${esc(o.from)} ‚Üí ${esc(S.my)}</div>
          <div class="offerSub">${esc(o.msg)}</div>
        </div>
        <span class="badge ${o.badge.cls}">${esc(o.badge.txt)}</span>
      </div>

      <div class="offerSplit">
        <div class="offerBox">
          <div class="lbl">You give</div>
          <div class="bigRow">${youRows}</div>
        </div>
        <div class="offerBox">
          <div class="lbl">You get</div>
          <div class="bigRow">${theyRows}</div>
        </div>
      </div>

      <div class="muted">${o.handled ? "‚úÖ handled" : "‚è≥ pending"}</div>
    `;

    div.onclick = ()=>{ S.selectedOfferId = o.id; render(); };
    list.appendChild(div);
  }
}

function renderOfferDetail(){
  const o = S.inbox.find(x=>x.id===S.selectedOfferId);
  const b = $("inBadge");

  if(!o){
    $("inTitle").textContent = "Incoming offers";
    $("inMsg").textContent = "Pick one to inspect.";
    b.style.display="none";
    $("inEval").textContent="‚Äî";
    $("inEval2").textContent="‚Äî";
    $("btnAccept").disabled=true;
    $("btnCounter").disabled=true;
    $("btnReject").disabled=true;
    return;
  }

  $("inTitle").textContent = `${o.from} ‚Üí ${S.my}`;
  $("inMsg").textContent = o.msg;
  b.style.display="";
  b.className = `badge ${o.badge.cls}`;
  b.textContent = o.badge.txt;

  const y = youNet(o.from, o.youGive, o.theyGive);
  const t = theirVerdict(o.from, o.youGive, o.theyGive);
  $("inEval").textContent = y.diff>=0 ? `Net: You WIN by ${y.diff}` : `Net: You LOSE by ${Math.abs(y.diff)}`;
  $("inEval2").textContent = `They likely: ${t.verdict.toUpperCase()} (theirScore=${t.score})`;

  const disabled = o.handled || (S.turn>S.maxTurns) || (power(S.my)>=S.targetPower);
  $("btnAccept").disabled=disabled;
  $("btnCounter").disabled=disabled;
  $("btnReject").disabled=disabled;
}

function renderRoster(team, containerId){
  const c = $(containerId);
  c.innerHTML = "";

  const items = roster(team).slice()
    .map(it=>({it, v:itemValue(it)}))
    .sort((a,b)=>b.v-a.v);

  for(const x of items){
    const div = document.createElement("div");
    div.className = "tile";
    div.draggable = true;
    div.dataset.team = team;
    div.dataset.name = x.it.name;

    div.addEventListener("dragstart",(ev)=>{
      ev.dataTransfer.setData("text/plain", JSON.stringify({team, name:x.it.name}));
    });

    div.innerHTML = `
      <div class="thumb">${imgHTML(x.it.img, x.it.name)}</div>
      <div class="tBottom">
        <div style="min-width:0;">
          <div class="tName" title="${esc(x.it.name)}">${esc(x.it.name)}</div>
          <div class="tTags">${(x.it.tags||[]).map(t=>"#"+esc(t)).join(" ")}</div>
        </div>
        <div class="tVal">${x.v}</div>
      </div>
    `;
    c.appendChild(div);
  }
}

function renderMake(){
  const target = $("targetTeam").value;

  $("myCount").textContent = `${roster(S.my).length} items`;
  $("themCount").textContent = `${roster(target).length} items`;

  renderRoster(S.my, "myRoster");
  renderRoster(target, "themRoster");

  const pkgYou = $("pkgYou");
  const pkgThey = $("pkgThey");

  pkgYou.innerHTML = S.pkgYou.length
    ? S.pkgYou.map(n=>pkgCardHTML(S.my,n,true)).join("")
    : `<div class="muted">Drop items here‚Ä¶</div>`;

  pkgThey.innerHTML = S.pkgThey.length
    ? S.pkgThey.map(n=>pkgCardHTML(target,n,true)).join("")
    : `<div class="muted">Drop items here‚Ä¶</div>`;

  pkgYou.onclick = (e)=>{
    const btn = e.target.closest("button[data-remove='1']");
    if(!btn) return;
    const card = e.target.closest(".pkgCard");
    const name = card?.dataset?.name;
    if(!name) return;
    S.pkgYou = S.pkgYou.filter(x=>x!==name);
    renderMake();
  };
  pkgThey.onclick = (e)=>{
    const btn = e.target.closest("button[data-remove='1']");
    if(!btn) return;
    const card = e.target.closest(".pkgCard");
    const name = card?.dataset?.name;
    if(!name) return;
    S.pkgThey = S.pkgThey.filter(x=>x!==name);
    renderMake();
  };

  if(S.pkgYou.length===0 || S.pkgThey.length===0){
    $("mkEval").textContent = "Build a proposal";
    $("mkEval2").textContent = "Drag items into both packages.";
  } else {
    const y = youNet(target, S.pkgYou, S.pkgThey);
    const t = theirVerdict(target, S.pkgYou, S.pkgThey);
    $("mkEval").textContent = y.diff>=0 ? `Net: You WIN by ${y.diff}` : `Net: You LOSE by ${Math.abs(y.diff)}`;
    $("mkEval2").textContent = `They likely: ${t.verdict.toUpperCase()} (theirScore=${t.score})`;
  }

  $("btnSend").disabled = (S.turn>S.maxTurns) || (power(S.my)>=S.targetPower);
}

function renderLogos(){
  const tgt = $("targetTeam")?.value || "";
  setLogo("logoLeftSlot", S.my, "YOU");
  setLogo("logoLeftPuck", S.my, "YOU");
  setLogo("logoRightSlot", tgt, "THEM");
  setLogo("logoRightPuck", tgt, "THEM");
}

function render(){
  renderTargets();
  renderHUD();
  renderOfferList();
  renderOfferDetail();
  renderLogos();
  if(S.tab==="make") renderMake();
}

/* Drag & Drop */
function wireDrop(zoneId, acceptFn){
  const z = $(zoneId);
  z.addEventListener("dragover",(ev)=>{ ev.preventDefault(); z.classList.add("dragover"); });
  z.addEventListener("dragleave",()=>z.classList.remove("dragover"));
  z.addEventListener("drop",(ev)=>{
    ev.preventDefault(); z.classList.remove("dragover");
    let payload=null;
    try{ payload = JSON.parse(ev.dataTransfer.getData("text/plain")); }catch{}
    if(payload) acceptFn(payload);
  });
}

/* Actions */
function startRun(){
  S.DATA = clone(DATA_SEED);
  S.my = $("myTeam").value;
  S.fairness = parseInt($("fairness").value,10) || 8;
  S.turn = 1;
  S.rep = 50;
  S.pkgYou = [];
  S.pkgThey = [];
  S.pendingCounter = null;
  $("log").innerHTML = "";

  genInbox();

  $("startCard").style.display = "none";
  $("gameShell").style.display = "flex";
  setTab("make");

  logLine(`üé¨ New run: CEO of <b>${esc(S.my)}</b>. Turn 1 begins.`);
  render();
}

function acceptSelected(){
  const o = S.inbox.find(x=>x.id===S.selectedOfferId);
  if(!o || o.handled) return;

  const y = youNet(o.from, o.youGive, o.theyGive);
  const blockbuster = isBlockbuster(o.from, o.youGive, o.theyGive);

  executeTrade(o.from, o.youGive, o.theyGive);
  o.handled = true;

  S.rep = clamp(S.rep + (y.diff>=0?3:-3), 0, 100);
  fxStatus("accepted", blockbuster);

  logLine(`‚úÖ Accepted <b>${esc(o.from)}</b>. Net ${y.diff>=0?"+":""}${y.diff}. Power <b>${power(S.my)}</b>.`);
  render();
}

function rejectSelected(){
  const o = S.inbox.find(x=>x.id===S.selectedOfferId);
  if(!o || o.handled) return;
  o.handled = true;
  S.rep = clamp(S.rep+1, 0, 100);
  fxStatus("rejected");
  logLine(`‚ùå Rejected <b>${esc(o.from)}</b>.`);
  render();
}

function counterSelected(){
  const o = S.inbox.find(x=>x.id===S.selectedOfferId);
  if(!o || o.handled) return;

  $("targetTeam").value = o.from;
  S.pkgYou = [...o.youGive];
  S.pkgThey = [...o.theyGive];

  fxStatus("countered");
  setTab("make");
  logLine(`üîÅ Countering <b>${esc(o.from)}</b>. Edit packages then Send.`);
  render();
}

function buildCounterOffer(target, yourGive, theirGive){
  const tgtRoster = roster(target).slice().sort((a,b)=>itemValue(b)-itemValue(a));
  const myRoster  = roster(S.my).slice().sort((a,b)=>itemValue(b)-itemValue(a));

  let newYouGive = [...yourGive];
  let newTheyGive = [...theirGive];

  if(newTheyGive.length>0 && Math.random()<0.55){
    const vals = newTheyGive.map(n=>({n,v:itemValue(findItem(target,n))})).sort((a,b)=>a.v-b.v);
    newTheyGive = newTheyGive.filter(n=>n!==vals[0].n);
  } else {
    const candidates = myRoster.map(x=>x.name).filter(n=>!newYouGive.includes(n));
    if(candidates.length){
      newYouGive.push(candidates[Math.floor(Math.random()*Math.min(3,candidates.length))]);
    }
  }
  if(newTheyGive.length===0){
    const fallback = tgtRoster.find(x=>!theirGive.includes(x.name));
    if(fallback) newTheyGive = [fallback.name];
  }
  return {youGive:newYouGive, theyGive:newTheyGive};
}

function sendOffer(){
  const target = $("targetTeam").value;
  if(S.pkgYou.length===0 || S.pkgThey.length===0){
    logLine("‚ö†Ô∏è Add items to BOTH sides before sending.");
    return;
  }

  const y = youNet(target, S.pkgYou, S.pkgThey);
  const t = theirVerdict(target, S.pkgYou, S.pkgThey);

  if(t.verdict==="accept"){
    const blockbuster = isBlockbuster(target, S.pkgYou, S.pkgThey);
    executeTrade(target, S.pkgYou, S.pkgThey);
    S.rep = clamp(S.rep+3, 0, 100);
    fxStatus("accepted", blockbuster);
    logLine(`üì§ <b>${esc(target)}</b> ACCEPTED. Net ${y.diff>=0?"+":""}${y.diff}. Power <b>${power(S.my)}</b>.`);

    openModal({
      title: blockbuster ? "üö® BLOCKBUSTER TRADE!" : "‚úÖ TRADE ACCEPTED",
      sub: `${target} agreed to your offer.`,
      badgeObj: badge(blockbuster ? "block" : "fair"),
      youGiveTeam: S.my, youGive: S.pkgYou,
      theyGiveTeam: target, theyGive: S.pkgThey,
      eval1: y.diff>=0 ? `Net: You WIN by ${y.diff}` : `Net: You LOSE by ${Math.abs(y.diff)}`,
      eval2: `Reputation: ${S.rep}`,
      buttonsHTML: `<button class="good" id="mCloseBtn">Nice</button>`
    });
    setTimeout(()=>{ const b=$("mCloseBtn"); if(b) b.onclick=closeModal; }, 0);

    S.pkgYou=[]; S.pkgThey=[];
    render();
    return;
  }

  if(t.verdict==="reject"){
    S.rep = clamp(S.rep-2, 0, 100);
    fxStatus("rejected");
    logLine(`‚ùå <b>${esc(target)}</b> REJECTED your offer.`);
    openModal({
      title: "‚ùå TRADE REJECTED",
      sub: `${target}: ‚ÄúNo chance.‚Äù`,
      badgeObj: badge("fleece"),
      youGiveTeam: S.my, youGive: S.pkgYou,
      theyGiveTeam: target, theyGive: S.pkgThey,
      eval1: y.diff>=0 ? `Net: You WIN by ${y.diff} (but they still said no)` : `Net: You LOSE by ${Math.abs(y.diff)}`,
      eval2: `Try adding value or lowering your ask.`,
      buttonsHTML: `<button class="ghost" id="mCloseBtn">Back</button>`
    });
    setTimeout(()=>{ const b=$("mCloseBtn"); if(b) b.onclick=closeModal; }, 0);
    render();
    return;
  }

  const counter = buildCounterOffer(target, S.pkgYou, S.pkgThey);
  S.pendingCounter = { target, original:{youGive:[...S.pkgYou], theyGive:[...S.pkgThey]}, counter };

  S.rep = clamp(S.rep-1, 0, 100);
  fxStatus("countered");
  logLine(`üîÅ <b>${esc(target)}</b> COUNTEROFFERED.`);

  const y2 = youNet(target, counter.youGive, counter.theyGive);
  openModal({
    title: "üîÅ COUNTEROFFER!",
    sub: `${target} changed the terms.`,
    badgeObj: badge("block"),
    youGiveTeam: S.my, youGive: counter.youGive,
    theyGiveTeam: target, theyGive: counter.theyGive,
    eval1: y2.diff>=0 ? `Net: You WIN by ${y2.diff}` : `Net: You LOSE by ${Math.abs(y2.diff)}`,
    eval2: `Accept it, reject it, or counter back by editing your offer.`,
    buttonsHTML: `
      <button class="good" id="mAccept">Accept Counter</button>
      <button class="danger" id="mReject">Reject</button>
      <button class="hot" id="mEdit">Counter Back</button>
    `
  });

  setTimeout(()=>{
    $("mAccept").onclick = ()=>{
      const pc = S.pendingCounter;
      if(!pc) return closeModal();

      const blockbuster = isBlockbuster(pc.target, pc.counter.youGive, pc.counter.theyGive);
      executeTrade(pc.target, pc.counter.youGive, pc.counter.theyGive);
      S.rep = clamp(S.rep+2, 0, 100);
      fxStatus("accepted", blockbuster);

      logLine(`‚úÖ Accepted ${esc(pc.target)} counter. Power <b>${power(S.my)}</b>.`);
      closeModal();
      S.pkgYou=[]; S.pkgThey=[];
      S.pendingCounter=null;
      render();
    };
    $("mReject").onclick = ()=>{
      fxStatus("rejected");
      logLine(`‚ùå Rejected ${esc(S.pendingCounter?.target||"")} counter.`);
      closeModal();
      S.pendingCounter=null;
      render();
    };
    $("mEdit").onclick = ()=>{
      const pc = S.pendingCounter;
      if(!pc) return closeModal();
      $("targetTeam").value = pc.target;
      S.pkgYou = [...pc.counter.youGive];
      S.pkgThey = [...pc.counter.theyGive];
      closeModal();
      setTab("make");
      logLine(`üõ†Ô∏è Editing counteroffer vs <b>${esc(pc.target)}</b>.`);
      S.pendingCounter=null;
      render();
    };
  }, 0);

  render();
}

function endTurn(){
  if(power(S.my) >= S.targetPower){
    logLine("üèÜ You already hit the goal! Start a new run.");
    return;
  }
  if(S.turn >= S.maxTurns){
    logLine("üèÅ Out of turns. Start a new run.");
    return;
  }
  S.turn++;
  S.pkgYou=[]; S.pkgThey=[];
  S.pendingCounter=null;
  genInbox();
  showBanner(`‚û°Ô∏è TURN ${S.turn}`, "#ffd27c", false);
  logLine(`‚û°Ô∏è Turn ${S.turn} begins. New inbox offers arrived.`);
  render();
}

/* Init */
function init(){
  $("myTeam").innerHTML = Object.keys(DATA_SEED).map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join("");

  $("startBtn").addEventListener("click", startRun);
  $("newRun").addEventListener("click", ()=>location.reload());
  $("endTurn").addEventListener("click", endTurn);
  $("clearProposal").addEventListener("click", ()=>{
    S.pkgYou=[]; S.pkgThey=[];
    logLine("üßº Cleared proposal.");
    render();
  });

  $("tabInbox").addEventListener("click", ()=>setTab("inbox"));
  $("tabMake").addEventListener("click", ()=>setTab("make"));

  $("btnAccept").addEventListener("click", acceptSelected);
  $("btnReject").addEventListener("click", rejectSelected);
  $("btnCounter").addEventListener("click", counterSelected);

  $("btnSend").addEventListener("click", sendOffer);

  $("targetTeam").addEventListener("change", ()=>{
    S.pkgThey = [];
    render();
  });

  $("mClose").addEventListener("click", closeModal);
  $("modalMask").addEventListener("click",(e)=>{ if(e.target.id==="modalMask") closeModal(); });

  wireDrop("pkgYou", (p)=>{
    if(S.tab!=="make") return;
    if(p.team !== S.my) return;
    if(!S.pkgYou.includes(p.name)) S.pkgYou.push(p.name);
    renderMake();
  });
  wireDrop("pkgThey", (p)=>{
    if(S.tab!=="make") return;
    const target = $("targetTeam").value;
    if(p.team !== target) return;
    if(!S.pkgThey.includes(p.name)) S.pkgThey.push(p.name);
    renderMake();
  });

  $("log").innerHTML = `<div class="muted">Start a run to begin.</div>`;

  resizeConfetti();
}

document.addEventListener("DOMContentLoaded", ()=>{
  try { init(); }
  catch(e){ console.error("Init failed:", e); alert("Init error. Open console (F12)."); }
});
</script>

</body>
</html>
