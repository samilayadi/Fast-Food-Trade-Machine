<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fast Food CEO Trade Machine</title>

<style>
  :root{
    --bg:#070a12; --panel:#0f1629; --panel2:#0b1020;
    --ink:#e8eefc; --muted:#b8c5e6; --line:#233055;
    --good:#6ef3b2; --bad:#ff7c7c; --warn:#ffd27c; --hot:#ff8bd3;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  body{ margin:0; color:var(--ink); background:linear-gradient(180deg,#070a12,#0b0f19); }
  header{ padding:14px 12px; border-bottom:1px solid var(--line); background:rgba(15,22,41,.95); position:sticky; top:0; z-index:10; }
  header h1{ margin:0; font-size:18px; }
  header p{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35; }

  .wrap{ max-width:1200px; margin:0 auto; padding:12px 12px 36px; }
  .card{ background:rgba(15,22,41,.92); border:1px solid var(--line); border-radius:16px; padding:12px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .muted{ color:var(--muted); font-size:12px; }
  .small{ font-size:11px; color:var(--muted); }

  select,button{
    background:var(--panel2); color:var(--ink);
    border:1px solid var(--line); border-radius:12px;
    padding:10px 10px; font-size:14px;
  }
  button{ cursor:pointer; font-weight:900; background:#1e2a4d; }
  button:hover{ filter:brightness(1.06); }
  button.good{ background:#153a2a; border-color:#2a664a; }
  button.danger{ background:#3a1b2a; border-color:#5a2741; }
  button.hot{ background:#3a1432; border-color:#6b2a5f; }
  button.ghost{ background:transparent; border:1px dashed var(--line); color:var(--muted); }
  button:disabled{ opacity:.5; cursor:not-allowed; }

  .hud{ display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:10px; margin-top:10px; }
  @media(max-width:980px){ .hud{ grid-template-columns:1fr 1fr; } }
  .hudBox{ border:1px solid var(--line); border-radius:16px; background:rgba(11,16,32,.7); padding:10px; }
  .hudBox .k{ font-size:12px; color:var(--muted); }
  .hudBox .v{ font-size:22px; font-weight:950; margin-top:4px; font-variant-numeric:tabular-nums; }
  .hudBox .s{ font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35; }

  .tabs{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
  .tab{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(11,16,32,.6); cursor:pointer; font-weight:950; }
  .tab.active{ outline:2px solid rgba(110,243,178,.45); }

  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
  @media(max-width:980px){ .grid2{ grid-template-columns:1fr; } }

  /* Big roster tiles (video-friendly) */
  .rosterGrid{
    display:grid;
    grid-template-columns: 1fr; /* 1 column = big cards */
    gap:12px;
    margin-top:10px;
  }
  .tile{
    display:flex; gap:12px; align-items:center;
    border:1px solid var(--line); border-radius:18px;
    background:rgba(11,16,32,.78);
    padding:12px; user-select:none; cursor:grab;
  }
  .tile:active{ cursor:grabbing; }
  .thumb{
    width:92px; height:92px;
    border-radius:18px;
    border:1px solid var(--line);
    overflow:hidden;
    background:var(--panel2);
    flex:0 0 auto;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .name{ font-weight:950; font-size:15px; }
  .meta{ font-size:12px; color:var(--muted); margin-top:4px; }
  .val{ margin-left:auto; font-weight:950; font-size:16px; font-variant-numeric:tabular-nums; }

  /* Drop zones (big cards inside) */
  .dropWrap{ margin-top:10px; border:1px solid var(--line); border-radius:16px; background:rgba(11,16,32,.55); padding:10px; }
  .dropTitle{ display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px; }
  .dropZone{
    min-height:200px;
    border:2px dashed rgba(184,197,230,.18);
    border-radius:16px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:stretch;
  }
  .dropZone.dragover{ border-color: var(--good); background: rgba(110,243,178,.06); }

  .pkgCard{
    display:flex; gap:12px; align-items:center;
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(15,22,41,.9);
    padding:10px;
    width:100%;
  }
  .mini{
    width:78px; height:78px;
    border-radius:16px;
    overflow:hidden;
    border:1px solid var(--line);
    background:var(--panel2);
    flex:0 0 auto;
  }
  .mini img{ width:100%; height:100%; object-fit:cover; display:block; }
  .pkgCard b{ font-size:14px; display:block; }
  .pkgCard span{ font-size:12px; color:var(--muted); display:block; margin-top:4px; }
  .pkgCard button{
    margin-left:auto;
    padding:8px 10px;
    border-radius:12px;
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted);
    font-size:12px;
    cursor:pointer;
  }

  /* Inbox cards */
  .offerList{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin-top:12px; }
  @media(max-width:980px){ .offerList{ grid-template-columns:1fr; } }
  .offerCard{ border:1px solid var(--line); border-radius:16px; background:rgba(11,16,32,.55); padding:10px; cursor:pointer; }
  .offerCard:hover{ filter:brightness(1.06); }
  .badge{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:11px; border:1px solid var(--line); font-weight:950; margin-bottom:8px; }
  .bF{ color:var(--bad); border-color: rgba(255,124,124,.45); background: rgba(255,124,124,.08); }
  .bR{ color:var(--good); border-color: rgba(110,243,178,.45); background: rgba(110,243,178,.07); }
  .bB{ color:var(--hot); border-color: rgba(255,139,211,.45); background: rgba(255,139,211,.08); }

  .divider{ height:1px; background:#1d2740; margin:10px 0; }
  .log{ margin-top:12px; border:1px solid var(--line); border-radius:16px; background:rgba(11,16,32,.55); padding:10px; max-height:220px; overflow:auto; font-size:12px; color:var(--muted); line-height:1.45; }
  .log b{ color:var(--ink); }

  /* FX overlay */
  #fxLayer{ position:fixed; inset:0; pointer-events:none; z-index:9999; }
  #tradeBanner{
    position:absolute; left:50%; top:14%;
    transform:translateX(-50%) translateY(-20px);
    opacity:0;
    padding:14px 18px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(10,14,24,.82);
    backdrop-filter: blur(10px);
    box-shadow:0 18px 45px rgba(0,0,0,.55);
    font:900 18px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    letter-spacing:.4px;
    white-space:nowrap;
  }
</style>
</head>

<body>
<header>
  <h1>üçî Fast Food CEO Trade Machine</h1>
  <p>Drag items into trade packages ‚Üí send offers ‚Üí accept/counter/reject inbox offers. Goal: <b>650 Menu Power</b> in 10 turns.</p>
</header>

<div class="wrap">
  <div class="card" id="startCard">
    <div class="row" style="justify-content:flex-start;">
      <div style="font-weight:950;">Choose your CEO</div>
      <span class="muted">Needs: <b>assets/items/placeholder.jpg</b></span>
    </div>
    <div class="row" style="margin-top:10px; justify-content:flex-start;">
      <label class="muted">My Chain</label>
      <select id="myTeam"></select>

      <label class="muted">Fairness</label>
      <select id="fairness">
        <option value="6">¬±6 strict</option>
        <option value="8" selected>¬±8 normal</option>
        <option value="12">¬±12 loose</option>
      </select>

      <button class="good" id="startBtn">Start Run</button>
    </div>
    <div class="small" style="margin-top:10px;">
      Tip: use smaller images (webp/jpg) so your PC stays smooth.
    </div>
  </div>

  <div id="gameCard" style="display:none;">
    <div class="card">
      <div class="row">
        <div class="row" style="justify-content:flex-start;">
          <button class="ghost" id="clearProposal">Clear Proposal</button>
          <button class="danger" id="newRun">New Run</button>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button class="hot" id="endTurn">End Turn ‚ûú</button>
        </div>
      </div>

      <div class="hud">
        <div class="hudBox">
          <div class="k">You are CEO of</div>
          <div class="v" id="hudTeam">‚Äî</div>
          <div class="s">Goal: 650 Power by Turn 10</div>
        </div>
        <div class="hudBox">
          <div class="k">Turn</div>
          <div class="v" id="hudTurn">1 / 10</div>
          <div class="s" id="hudInbox">Inbox offers: 3</div>
        </div>
        <div class="hudBox">
          <div class="k">Menu Power</div>
          <div class="v" id="hudPower">0</div>
          <div class="s" id="hudPowerNote">Trade to improve your menu.</div>
        </div>
        <div class="hudBox">
          <div class="k">Reputation</div>
          <div class="v" id="hudRep">50</div>
          <div class="s" id="hudRepNote">Higher rep = fewer fleeces.</div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" id="tabInbox">üì• Inbox</div>
        <div class="tab" id="tabMake">üì§ Make Offer</div>
      </div>

      <!-- INBOX VIEW -->
      <div id="viewInbox" style="margin-top:12px;">
        <div class="offerList" id="offerList"></div>

        <div class="divider"></div>

        <div class="card" style="background:rgba(11,16,32,.55); border:1px solid var(--line);">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div style="font-weight:950;" id="inTitle">Select an offer</div>
              <div class="muted" id="inMsg">‚Äî</div>
            </div>
            <div class="row">
              <span class="badge bR" id="inBadge" style="display:none;">FAIR</span>
              <button class="good" id="btnAccept" disabled>Accept</button>
              <button class="ghost" id="btnCounter" disabled>Counter</button>
              <button class="danger" id="btnReject" disabled>Reject</button>
            </div>
          </div>

          <div class="grid2">
            <div>
              <div style="font-weight:950;">You give</div>
              <div class="dropWrap"><div class="dropZone" id="inYou"></div></div>
            </div>
            <div>
              <div style="font-weight:950;">They give</div>
              <div class="dropWrap"><div class="dropZone" id="inThey"></div></div>
            </div>
          </div>

          <div class="divider"></div>
          <div style="font-weight:950;" id="inEval">‚Äî</div>
          <div class="muted" id="inEval2">‚Äî</div>
        </div>
      </div>

      <!-- MAKE OFFER VIEW -->
      <div id="viewMake" style="display:none; margin-top:12px;">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-weight:950;">Drag & Drop Offer Builder</div>
            <div class="muted">Drag from rosters into the two packages. Then click Send. (1 offer per turn)</div>
          </div>
          <div class="row" style="justify-content:flex-end;">
            <label class="muted">Target CEO</label>
            <select id="targetTeam"></select>
            <button class="good" id="btnSend">Send Offer</button>
          </div>
        </div>

        <div class="grid2">
          <div class="card" style="background:rgba(11,16,32,.55); border:1px solid var(--line);">
            <div style="font-weight:950;">Your Menu</div>
            <div class="muted" id="myCount"></div>
            <div class="rosterGrid" id="myRoster"></div>

            <div class="dropWrap">
              <div class="dropTitle"><b>You give</b><span class="muted">Drop here</span></div>
              <div class="dropZone" id="pkgYou"></div>
            </div>
          </div>

          <div class="card" style="background:rgba(11,16,32,.55); border:1px solid var(--line);">
            <div style="font-weight:950;">Target Menu</div>
            <div class="muted" id="themCount"></div>
            <div class="rosterGrid" id="themRoster"></div>

            <div class="dropWrap">
              <div class="dropTitle"><b>They give</b><span class="muted">Drop here</span></div>
              <div class="dropZone" id="pkgThey"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div style="font-weight:950;" id="mkEval">Build a proposal</div>
        <div class="muted" id="mkEval2">Drag items into both packages.</div>
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>
</div>

<div id="fxLayer"><div id="tradeBanner"></div></div>

<script>
/* =========================
   FAST FOOD CEO TRADE MACHINE
   Single-file, stable, lightweight
========================= */

const PLACEHOLDER = "assets/items/placeholder.jpg";

const DATA_SEED = {
  "McDonald's":[
    {name:"Big Mac",base:86,tags:["iconic"],img:"assets/items/big-mac.jpg"},
    {name:"Fries",base:80,tags:["iconic","speed"],img:"assets/items/mcd-fries.jpg"},
    {name:"Nuggets (10pc)",base:78,tags:["iconic"],img:"assets/items/nuggets.jpg"},
    {name:"McFlurry",base:74,tags:["broken"],img:"assets/items/mcflurry.jpg"},
    {name:"Egg McMuffin",base:76,tags:["iconic"],img:"assets/items/egg-mcmuffin.jpg"},
    {name:"Hash Browns",base:70,tags:["speed"],img:"assets/items/hash-browns.jpg"},
    {name:"Filet-O-Fish",base:72,tags:["iconic"],img:"assets/items/filet-o-fish.jpg"}
  ],
  "Taco Bell":[
    {name:"Baja Blast",base:90,tags:["iconic"],img:"assets/items/baja-blast.jpg"},
    {name:"Crunchwrap Supreme",base:88,tags:["iconic"],img:"assets/items/crunchwrap.jpg"},
    {name:"Doritos Locos Taco",base:84,tags:["iconic"],img:"assets/items/doritos-locos.jpg"},
    {name:"Quesadilla",base:80,tags:["iconic"],img:"assets/items/tb-quesadilla.jpg"},
    {name:"Nacho Fries (LTO)",base:83,tags:["lto"],img:"assets/items/nacho-fries.jpg"},
    {name:"Fire Sauce",base:64,tags:["sauce"],img:"assets/items/fire-sauce.jpg"},
    {name:"Cinnamon Twists",base:70,tags:["dessert"],img:"assets/items/cinnamon-twists.jpg"}
  ],
  "Chick-fil-A":[
    {name:"Chicken Sandwich",base:90,tags:["iconic"],img:"assets/items/chicken-sandwich.jpg"},
    {name:"Spicy Chicken Sandwich",base:92,tags:["iconic"],img:"assets/items/spicy-chicken-sandwich.jpg"},
    {name:"Waffle Fries",base:86,tags:["iconic","speed"],img:"assets/items/waffle-fries.jpg"},
    {name:"Nuggets (12ct)",base:82,tags:["iconic"],img:"assets/items/cfa-nuggets.jpg"},
    {name:"Chick-fil-A Sauce",base:66,tags:["sauce"],img:"assets/items/cfa-sauce.jpg"},
    {name:"Lemonade",base:75,tags:["iconic"],img:"assets/items/cfa-lemonade.jpg"},
    {name:"Mac & Cheese",base:74,tags:["iconic"],img:"assets/items/mac-and-cheese.jpg"}
  ],
  "Raising Cane's":[
    {name:"Box Combo",base:88,tags:["iconic"],img:"assets/items/box-combo.jpg"},
    {name:"Chicken Fingers",base:86,tags:["iconic"],img:"assets/items/chicken-fingers.jpg"},
    {name:"Cane's Sauce",base:70,tags:["sauce","iconic"],img:"assets/items/canes-sauce.jpg"},
    {name:"Texas Toast",base:76,tags:["iconic"],img:"assets/items/texas-toast.jpg"},
    {name:"Crinkle Fries",base:80,tags:["speed"],img:"assets/items/crinkle-fries.jpg"},
    {name:"Lemonade",base:74,tags:["iconic"],img:"assets/items/rc-lemonade.jpg"},
    {name:"Coleslaw",base:66,tags:[],img:"assets/items/coleslaw.jpg"}
  ],
  "Burger King":[
    {name:"Whopper",base:84,tags:["iconic"],img:"assets/items/whopper.jpg"},
    {name:"Fries",base:76,tags:["speed"],img:"assets/items/bk-fries.jpg"},
    {name:"Onion Rings",base:73,tags:["iconic"],img:"assets/items/onion-rings.jpg"},
    {name:"Chicken Fries",base:76,tags:["iconic"],img:"assets/items/chicken-fries.jpg"},
    {name:"Impossible Whopper (LTO)",base:78,tags:["lto"],img:"assets/items/impossible-whopper.jpg"},
    {name:"Croissan'wich",base:72,tags:["iconic"],img:"assets/items/croissanwich.jpg"},
    {name:"Chocolate Pie",base:70,tags:["dessert"],img:"assets/items/chocolate-pie.jpg"}
  ],
  "Chipotle":[
    {name:"Burrito",base:86,tags:["iconic"],img:"assets/items/burrito.jpg"},
    {name:"Bowl",base:86,tags:["iconic"],img:"assets/items/bowl.jpg"},
    {name:"Chips & Guac",base:80,tags:["upgrade","iconic"],img:"assets/items/chips-guac.jpg"},
    {name:"Queso",base:74,tags:["upgrade"],img:"assets/items/queso.jpg"},
    {name:"Barbacoa",base:82,tags:["iconic"],img:"assets/items/barbacoa.jpg"},
    {name:"Vinaigrette",base:64,tags:["sauce"],img:"assets/items/vinaigrette.jpg"},
    {name:"Hot Salsa",base:64,tags:["sauce"],img:"assets/items/hot-salsa.jpg"}
  ],
  "Panda Express":[
    {name:"Orange Chicken",base:90,tags:["iconic"],img:"assets/items/orange-chicken.jpg"},
    {name:"Chow Mein",base:82,tags:["iconic"],img:"assets/items/chow-mein.jpg"},
    {name:"Fried Rice",base:80,tags:["iconic"],img:"assets/items/fried-rice.jpg"},
    {name:"Beijing Beef",base:84,tags:["iconic"],img:"assets/items/beijing-beef.jpg"},
    {name:"Walnut Shrimp (LTO)",base:86,tags:["lto"],img:"assets/items/walnut-shrimp.jpg"},
    {name:"Super Greens",base:70,tags:[],img:"assets/items/super-greens.jpg"},
    {name:"Fortune Cookie",base:62,tags:["nostalgia"],img:"assets/items/fortune-cookie.jpg"}
  ],
  "Subway":[
    {name:"Footlong Sub",base:80,tags:["iconic"],img:"assets/items/footlong-sub.jpg"},
    {name:"Italian B.M.T.",base:82,tags:["iconic"],img:"assets/items/italian-bmt.jpg"},
    {name:"Meatball Marinara",base:80,tags:["iconic"],img:"assets/items/meatball.jpg"},
    {name:"Tuna Sub",base:74,tags:["iconic"],img:"assets/items/tuna-sub.jpg"},
    {name:"Cookies",base:70,tags:["dessert"],img:"assets/items/subway-cookies.jpg"},
    {name:"Southwest Sauce",base:64,tags:["sauce"],img:"assets/items/subway-southwest.jpg"},
    {name:"Soft Pretzel (LTO)",base:72,tags:["lto"],img:"assets/items/soft-pretzel.jpg"}
  ],
  "Domino's":[
    {name:"Pepperoni Pizza",base:90,tags:["iconic"],img:"assets/items/pepperoni-pizza.jpg"},
    {name:"Cheesy Bread",base:82,tags:["iconic"],img:"assets/items/cheesy-bread.jpg"},
    {name:"Wings",base:84,tags:["iconic"],img:"assets/items/wings.jpg"},
    {name:"Cinnamon Twists",base:74,tags:["dessert"],img:"assets/items/dom-cinnamon.jpg"},
    {name:"Lava Cake",base:78,tags:["dessert","iconic"],img:"assets/items/lava-cake.jpg"},
    {name:"Garlic Dip",base:64,tags:["sauce"],img:"assets/items/garlic-dip.jpg"},
    {name:"Stuffed Crust (LTO)",base:82,tags:["lto"],img:"assets/items/stuffed-crust.jpg"}
  ],
  "Wendy's":[
    {name:"Baconator",base:88,tags:["iconic"],img:"assets/items/baconator.jpg"},
    {name:"Dave's Single",base:82,tags:["iconic"],img:"assets/items/daves-single.jpg"},
    {name:"Spicy Nuggets",base:83,tags:["iconic"],img:"assets/items/spicy-nuggets.jpg"},
    {name:"Spicy Chicken Sandwich",base:84,tags:["iconic"],img:"assets/items/wendys-spicy-chicken.jpg"},
    {name:"Fries",base:76,tags:["speed"],img:"assets/items/wendys-fries.jpg"},
    {name:"Frosty",base:80,tags:["iconic"],img:"assets/items/frosty.jpg"},
    {name:"Chili",base:72,tags:["iconic"],img:"assets/items/chili.jpg"}
  ]
};

const BONUS = { sauce:6, lto:8, iconic:5, broken:-7, speed:3, upgrade:4, dessert:2, nostalgia:2 };

const PERSONALITY = {
  "McDonald's":{stingy:0.75, block:0.10},
  "Taco Bell":{stingy:0.45, block:0.22},
  "Chick-fil-A":{stingy:0.60, block:0.14},
  "Raising Cane's":{stingy:0.55, block:0.12},
  "Burger King":{stingy:0.50, block:0.15},
  "Chipotle":{stingy:0.70, block:0.12},
  "Panda Express":{stingy:0.62, block:0.13},
  "Subway":{stingy:0.52, block:0.10},
  "Domino's":{stingy:0.45, block:0.20},
  "Wendy's":{stingy:0.55, block:0.14}
};

const $ = (id)=>document.getElementById(id);
const clone = (x)=>JSON.parse(JSON.stringify(x));
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const esc = (s)=>(s+"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

function imgHTML(src, alt){
  const safe = src || PLACEHOLDER;
  return `<img src="${safe}" alt="${esc(alt)}" loading="lazy"
    onerror="this.onerror=null;this.src='${PLACEHOLDER}';">`;
}

let S = {
  DATA: clone(DATA_SEED),
  my: null,
  turn: 1,
  maxTurns: 10,
  targetPower: 650,
  rep: 50,
  fairness: 8,
  outboundUsed: false,
  tab: "inbox",
  inbox: [],
  selectedOfferId: null,
  pkgYou: [],
  pkgThey: []
};

function itemValue(it){
  if(!it) return 0;
  let v = it.base;
  for(const t of (it.tags||[])) if(BONUS[t]!=null) v += BONUS[t];
  return v;
}
function roster(team){ return S.DATA[team] || []; }
function power(team){ return roster(team).reduce((a,it)=>a+itemValue(it),0); }
function findItem(team, name){ return roster(team).find(x=>x.name===name) || null; }
function sumNames(team, names){
  let total = 0;
  const r = roster(team);
  for(const n of names){
    const it = r.find(x=>x.name===n);
    if(it) total += itemValue(it);
  }
  return total;
}

function youNet(other, youGive, theyGive){
  const give = sumNames(S.my, youGive);
  const get  = sumNames(other, theyGive);
  return {give, get, diff: (get-give)};
}
function theirVerdict(other, youGive, theyGive){
  const p = PERSONALITY[other] || {stingy:0.55, block:0.12};
  const received = sumNames(S.my, youGive);
  const given    = sumNames(other, theyGive);
  const score = received - given; // + better for them

  const repPenalty = (S.rep < 35) ? 6 : (S.rep < 50) ? 3 : 0;
  const stingyNeed = Math.round((p.stingy - 0.50) * 14);
  const acceptThresh = -Math.floor(S.fairness/2) + stingyNeed + repPenalty;
  const counterThresh = -Math.floor(S.fairness*1.7) + stingyNeed + repPenalty;

  let verdict = "reject";
  if(score >= acceptThresh) verdict = "accept";
  else if(score >= counterThresh) verdict = "counter";
  return {score, verdict, acceptThresh};
}

/* ===== FX (light) ===== */
(function setupFX(){
  const banner = $("tradeBanner");
  const style = document.createElement("style");
  style.textContent = `
    @keyframes bannerIn {
      0% { opacity:0; transform:translateX(-50%) translateY(-22px) scale(.96); filter:blur(2px); }
      20%{ opacity:1; transform:translateX(-50%) translateY(0px) scale(1); filter:blur(0px); }
      80%{ opacity:1; transform:translateX(-50%) translateY(0px) scale(1); }
      100%{ opacity:0; transform:translateX(-50%) translateY(-14px) scale(.985); }
    }
    @keyframes screenShake {
      0%{ transform:translate(0,0); }
      20%{ transform:translate(6px,-4px); }
      40%{ transform:translate(-6px,3px); }
      60%{ transform:translate(5px,4px); }
      80%{ transform:translate(-4px,-3px); }
      100%{ transform:translate(0,0); }
    }
    @keyframes flashRed {
      0%{ box-shadow: inset 0 0 0 0 rgba(255,90,90,0); }
      35%{ box-shadow: inset 0 0 0 18px rgba(255,90,90,.12); }
      100%{ box-shadow: inset 0 0 0 0 rgba(255,90,90,0); }
    }
  `;
  document.head.appendChild(style);

  window.tradeFX = function(kind){
    let text="‚úÖ TRADE COMPLETE", color="#6ef3b2";
    if(kind==="block"){ text="üö® BLOCKBUSTER üö®"; color="#ff8bd3"; }
    else if(kind==="fair"){ text="ü§ù FAIR DEAL ü§ù"; color="#6ef3b2"; }
    else if(kind==="fleece"){ text="üòà YOU GOT FLEECED üòà"; color="#ff7c7c"; }

    banner.textContent = text;
    banner.style.color = color;
    banner.style.animation = "none";
    banner.offsetHeight;
    banner.style.animation = "bannerIn 1400ms ease-out forwards";

    if(kind==="fleece"){
      document.body.style.animation="none";
      document.body.offsetHeight;
      document.body.style.animation="screenShake 420ms ease-in-out, flashRed 520ms ease-out";
    }
  };
})();

/* ===== UI helpers ===== */
function logLine(html){
  const box = $("log");
  box.innerHTML = `<div>${html}</div>` + box.innerHTML;
}

function setTab(tab){
  S.tab = tab;
  $("tabInbox").classList.toggle("active", tab==="inbox");
  $("tabMake").classList.toggle("active", tab==="make");
  $("viewInbox").style.display = (tab==="inbox") ? "" : "none";
  $("viewMake").style.display  = (tab==="make")  ? "" : "none";
  render();
}

/* ===== Offer generation ===== */
function badge(type){
  if(type==="block") return {txt:"BLOCKBUSTER üö®", cls:"bB"};
  if(type==="fleece") return {txt:"FLEECE üòà", cls:"bF"};
  return {txt:"FAIR ü§ù", cls:"bR"};
}
function topItems(team){
  return roster(team).slice()
    .map(it=>({name:it.name, v:itemValue(it)}))
    .sort((a,b)=>b.v-a.v);
}

function genInbox(){
  S.inbox = [];
  const others = Object.keys(S.DATA).filter(t=>t!==S.my);
  const myTop = topItems(S.my);

  for(let i=0;i<3;i++){
    const from = pick(others);
    const p = PERSONALITY[from] || {stingy:0.55, block:0.12};

    let blockChance = clamp(p.block + (S.rep>70?0.08:S.rep>60?0.04:0), 0.05, 0.35);
    let fleeceChance = clamp(0.42 + (S.rep<40?0.18:S.rep<55?0.08:-0.05), 0.15, 0.75);

    const r = Math.random();
    let type = "fair";
    if(r < blockChance) type = "block";
    else if(r < blockChance + fleeceChance) type = "fleece";

    const theirTop = topItems(from);
    let youGive=[], theyGive=[];
    if(type==="fleece"){
      youGive=[myTop[0]?.name].filter(Boolean);
      theyGive=[theirTop[theirTop.length-1]?.name].filter(Boolean);
    } else if(type==="block"){
      youGive=[myTop[0]?.name, myTop[1]?.name].filter(Boolean);
      theyGive=[theirTop[0]?.name, theirTop[1]?.name].filter(Boolean);
    } else {
      youGive=[myTop[2]?.name || myTop[0]?.name].filter(Boolean);
      theyGive=[theirTop[2]?.name || theirTop[0]?.name].filter(Boolean);
    }

    const b = badge(type);
    S.inbox.push({
      id: `o_${S.turn}_${i}_${from.replace(/\W/g,"")}_${Math.random().toString(16).slice(2)}`,
      from, type, badge:b,
      youGive, theyGive,
      msg: type==="fleece" ? "‚ÄúThis is extremely fair.‚Äù" : type==="block" ? "‚ÄúLet‚Äôs change the game.‚Äù" : "‚ÄúSolid deal.‚Äù",
      handled:false
    });
  }
  S.selectedOfferId = S.inbox[0]?.id || null;
}

/* ===== Trading ===== */
function executeTrade(other, youGive, theyGive){
  const myR = roster(S.my);
  const thR = roster(other);

  const myGiveItems = youGive.map(n=>findItem(S.my,n)).filter(Boolean);
  const thGiveItems = theyGive.map(n=>findItem(other,n)).filter(Boolean);

  S.DATA[S.my] = myR.filter(it=>!youGive.includes(it.name)).concat(thGiveItems);
  S.DATA[other] = thR.filter(it=>!theyGive.includes(it.name)).concat(myGiveItems);
}

/* ===== Rendering (optimized: rebuild only small sections) ===== */
function renderHUD(){
  $("hudTeam").textContent = S.my || "‚Äî";
  $("hudTurn").textContent = `${S.turn} / ${S.maxTurns}`;
  $("hudPower").textContent = power(S.my);
  $("hudRep").textContent = S.rep;
  const pending = S.inbox.filter(o=>!o.handled).length;
  $("hudInbox").textContent = `Inbox offers: ${pending}`;

  $("hudPowerNote").textContent = (power(S.my) >= S.targetPower) ? "üèÜ Target hit!" : "Trade to improve your menu.";
  $("hudRepNote").textContent = S.rep>=60 ? "Respected üôÇ" : S.rep>=40 ? "Neutral üòê" : S.rep>=20 ? "Sketchy üòí" : "Public Enemy üò§";
}

function renderOfferList(){
  const list = $("offerList");
  list.innerHTML = "";
  for(const o of S.inbox){
    const div = document.createElement("div");
    div.className = "offerCard";
    div.dataset.offerId = o.id;
    div.innerHTML = `
      <span class="badge ${o.badge.cls}">${esc(o.badge.txt)}</span>
      <div style="font-weight:950">${esc(o.from)} ‚Üí ${esc(S.my)}</div>
      <div class="muted" style="margin-top:6px;">${esc(o.msg)}</div>
      <div class="muted" style="margin-top:6px;">${o.handled ? "‚úÖ handled" : "‚è≥ pending"}</div>
    `;
    div.onclick = ()=>{ S.selectedOfferId = o.id; renderOfferDetail(); };
    list.appendChild(div);
  }
}

function pkgCardHTML(team, name, removable){
  const it = findItem(team, name);
  const v = itemValue(it);
  const img = it?.img || PLACEHOLDER;
  return `
    <div class="pkgCard" data-name="${esc(name)}">
      <div class="mini">${imgHTML(img, name)}</div>
      <div style="min-width:0;">
        <b title="${esc(name)}">${esc(name)}</b>
        <span>Value: ${v}</span>
      </div>
      ${removable ? `<button data-remove="1" title="Remove">Remove</button>` : ``}
    </div>
  `;
}

function renderOfferDetail(){
  const o = S.inbox.find(x=>x.id===S.selectedOfferId);
  const inYou = $("inYou");
  const inThey = $("inThey");
  inYou.innerHTML = "";
  inThey.innerHTML = "";

  if(!o){
    $("inTitle").textContent = "Select an offer";
    $("inMsg").textContent = "‚Äî";
    $("inBadge").style.display = "none";
    $("inEval").textContent = "‚Äî";
    $("inEval2").textContent = "‚Äî";
    $("btnAccept").disabled = true;
    $("btnCounter").disabled = true;
    $("btnReject").disabled = true;
    return;
  }

  $("inTitle").textContent = `${o.from} offer`;
  $("inMsg").textContent = o.msg;
  const b = $("inBadge");
  b.style.display = "";
  b.className = `badge ${o.badge.cls}`;
  b.textContent = o.badge.txt;

  inYou.innerHTML = (o.youGive.length ? o.youGive.map(n=>pkgCardHTML(S.my,n,false)).join("") : `<div class="muted">Nothing</div>`);
  inThey.innerHTML = (o.theyGive.length ? o.theyGive.map(n=>pkgCardHTML(o.from,n,false)).join("") : `<div class="muted">Nothing</div>`);

  const y = youNet(o.from, o.youGive, o.theyGive);
  const t = theirVerdict(o.from, o.youGive, o.theyGive);
  $("inEval").textContent = y.diff>=0 ? `Net: You WIN by ${y.diff}` : `Net: You LOSE by ${Math.abs(y.diff)}`;
  $("inEval2").textContent = `They likely: ${t.verdict.toUpperCase()} (theirScore=${t.score})`;

  const disabled = o.handled || (S.turn > S.maxTurns) || (power(S.my) >= S.targetPower);
  $("btnAccept").disabled = disabled;
  $("btnCounter").disabled = disabled;
  $("btnReject").disabled = disabled;
}

function renderRoster(team, containerId){
  const c = $(containerId);
  c.innerHTML = "";

  const items = roster(team).slice()
    .map(it=>({it, v:itemValue(it)}))
    .sort((a,b)=>b.v-a.v);

  for(const x of items){
    const div = document.createElement("div");
    div.className = "tile";
    div.draggable = true;
    div.dataset.team = team;
    div.dataset.name = x.it.name;

    div.addEventListener("dragstart",(ev)=>{
      ev.dataTransfer.setData("text/plain", JSON.stringify({team, name:x.it.name}));
    });

    div.innerHTML = `
      <div class="thumb">${imgHTML(x.it.img, x.it.name)}</div>
      <div style="min-width:0;">
        <div class="name">${esc(x.it.name)}</div>
        <div class="meta">${(x.it.tags||[]).map(t=>"#"+esc(t)).join(" ")}</div>
      </div>
      <div class="val">${x.v}</div>
    `;
    c.appendChild(div);
  }
}

function renderMake(){
  const target = $("targetTeam").value;
  $("myCount").textContent = `${roster(S.my).length} items`;
  $("themCount").textContent = `${roster(target).length} items`;

  renderRoster(S.my, "myRoster");
  renderRoster(target, "themRoster");

  const pkgYou = $("pkgYou");
  const pkgThey = $("pkgThey");

  pkgYou.innerHTML = S.pkgYou.length
    ? S.pkgYou.map(n=>pkgCardHTML(S.my,n,true)).join("")
    : `<div class="muted">Drop items here‚Ä¶</div>`;

  pkgThey.innerHTML = S.pkgThey.length
    ? S.pkgThey.map(n=>pkgCardHTML(target,n,true)).join("")
    : `<div class="muted">Drop items here‚Ä¶</div>`;

  // wire remove buttons via event delegation
  pkgYou.onclick = (e)=>{
    const btn = e.target.closest("button[data-remove='1']");
    if(!btn) return;
    const card = e.target.closest(".pkgCard");
    const name = card?.dataset?.name;
    if(!name) return;
    S.pkgYou = S.pkgYou.filter(x=>x!==name);
    renderMake();
  };
  pkgThey.onclick = (e)=>{
    const btn = e.target.closest("button[data-remove='1']");
    if(!btn) return;
    const card = e.target.closest(".pkgCard");
    const name = card?.dataset?.name;
    if(!name) return;
    S.pkgThey = S.pkgThey.filter(x=>x!==name);
    renderMake();
  };

  // evaluation
  if(S.pkgYou.length===0 || S.pkgThey.length===0){
    $("mkEval").textContent = "Build a proposal";
    $("mkEval2").textContent = "Drag items into both packages.";
  } else {
    const y = youNet(target, S.pkgYou, S.pkgThey);
    const t = theirVerdict(target, S.pkgYou, S.pkgThey);
    $("mkEval").textContent = y.diff>=0 ? `Net: You WIN by ${y.diff}` : `Net: You LOSE by ${Math.abs(y.diff)}`;
    $("mkEval2").textContent = `They likely: ${t.verdict.toUpperCase()} (theirScore=${t.score})`;
  }

  $("btnSend").disabled = S.outboundUsed || (S.turn>S.maxTurns) || (power(S.my)>=S.targetPower);
}

function renderTargets(){
  const sel = $("targetTeam");
  const teams = Object.keys(S.DATA).filter(t=>t!==S.my);
  const prev = sel.value;
  sel.innerHTML = teams.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join("");
  sel.value = teams.includes(prev) ? prev : teams[0];
}

function render(){
  renderHUD();
  renderOfferList();
  renderOfferDetail();
  renderTargets();
  if(S.tab==="make") renderMake();
}

/* ===== DnD ===== */
function wireDrop(zoneId, acceptFn){
  const z = $(zoneId);
  z.addEventListener("dragover",(ev)=>{ ev.preventDefault(); z.classList.add("dragover"); });
  z.addEventListener("dragleave",()=>z.classList.remove("dragover"));
  z.addEventListener("drop",(ev)=>{
    ev.preventDefault(); z.classList.remove("dragover");
    let payload=null;
    try{ payload = JSON.parse(ev.dataTransfer.getData("text/plain")); }catch{}
    if(payload) acceptFn(payload);
  });
}

/* ===== Actions ===== */
function startRun(){
  S.DATA = clone(DATA_SEED);
  S.my = $("myTeam").value;
  S.fairness = parseInt($("fairness").value,10) || 8;
  S.turn = 1;
  S.rep = 50;
  S.outboundUsed = false;
  S.pkgYou = [];
  S.pkgThey = [];

  $("log").innerHTML = "";
  genInbox();

  $("startCard").style.display = "none";
  $("gameCard").style.display = "";

  setTab("inbox");
  logLine(`üé¨ New run: CEO of <b>${esc(S.my)}</b>. Turn 1 begins.`);
  render();
}

function acceptSelected(){
  const o = S.inbox.find(x=>x.id===S.selectedOfferId);
  if(!o || o.handled) return;

  const y = youNet(o.from, o.youGive, o.theyGive);
  if(y.diff>=18) tradeFX("block");
  else if(y.diff>=-S.fairness) tradeFX("fair");
  else tradeFX("fleece");

  executeTrade(o.from, o.youGive, o.theyGive);
  o.handled = true;

  S.rep = clamp(S.rep + (y.diff>=0?3:-3), 0, 100);
  logLine(`‚úÖ Accepted <b>${esc(o.from)}</b>. Net ${y.diff>=0?"+":""}${y.diff}. Power <b>${power(S.my)}</b>.`);
  render();
}

function rejectSelected(){
  const o = S.inbox.find(x=>x.id===S.selectedOfferId);
  if(!o || o.handled) return;
  o.handled = true;
  tradeFX("fleece");
  S.rep = clamp(S.rep+1, 0, 100);
  logLine(`‚ùå Rejected <b>${esc(o.from)}</b>.`);
  render();
}

function counterSelected(){
  const o = S.inbox.find(x=>x.id===S.selectedOfferId);
  if(!o || o.handled) return;
  $("targetTeam").value = o.from;
  S.pkgYou = [...o.youGive];
  S.pkgThey = [...o.theyGive];
  tradeFX("fair");
  setTab("make");
  logLine(`üîÅ Countering <b>${esc(o.from)}</b>. Adjust packages and hit Send.`);
  render();
}

function sendOffer(){
  if(S.outboundUsed) return;
  const target = $("targetTeam").value;

  if(S.pkgYou.length===0 || S.pkgThey.length===0){
    logLine("‚ö†Ô∏è Add items to BOTH sides before sending.");
    return;
  }
  S.outboundUsed = true;

  const t = theirVerdict(target, S.pkgYou, S.pkgThey);
  const y = youNet(target, S.pkgYou, S.pkgThey);

  if(t.verdict==="accept"){
    if(y.diff>=18) tradeFX("block");
    else if(y.diff>=-S.fairness) tradeFX("fair");
    else tradeFX("fleece");

    executeTrade(target, S.pkgYou, S.pkgThey);
    S.rep = clamp(S.rep+3, 0, 100);
    logLine(`üì§ <b>${esc(target)}</b> ACCEPTED. Net ${y.diff>=0?"+":""}${y.diff}.`);
    S.pkgYou=[]; S.pkgThey=[];
  } else if(t.verdict==="counter"){
    tradeFX("fair");
    S.rep = clamp(S.rep-1, 0, 100);
    logLine(`üîÅ <b>${esc(target)}</b> COUNTERED: ‚ÄúNeed more value.‚Äù Add an item.`);
  } else {
    tradeFX("fleece");
    S.rep = clamp(S.rep-2, 0, 100);
    logLine(`‚ùå <b>${esc(target)}</b> REJECTED your offer.`);
  }
  render();
}

function endTurn(){
  if(power(S.my) >= S.targetPower){
    logLine("üèÜ You already hit the goal! Start a new run.");
    return;
  }
  if(S.turn >= S.maxTurns){
    logLine("üèÅ Out of turns. Start a new run.");
    return;
  }
  S.turn++;
  S.outboundUsed = false;
  S.pkgYou=[]; S.pkgThey=[];
  genInbox();
  tradeFX("fair");
  logLine(`‚û°Ô∏è Turn ${S.turn} begins. New inbox offers arrived.`);
  render();
}

/* ===== INIT ===== */
function init(){
  // Fill CEO dropdown
  const mySel = $("myTeam");
  mySel.innerHTML = Object.keys(DATA_SEED).map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join("");

  // Buttons
  $("startBtn").addEventListener("click", startRun);
  $("newRun").addEventListener("click", ()=>location.reload());
  $("endTurn").addEventListener("click", endTurn);
  $("clearProposal").addEventListener("click", ()=>{
    S.pkgYou=[]; S.pkgThey=[];
    logLine("üßº Cleared proposal.");
    render();
  });

  // Tabs
  $("tabInbox").addEventListener("click", ()=>setTab("inbox"));
  $("tabMake").addEventListener("click", ()=>setTab("make"));

  // Inbox actions
  $("btnAccept").addEventListener("click", acceptSelected);
  $("btnReject").addEventListener("click", rejectSelected);
  $("btnCounter").addEventListener("click", counterSelected);

  // Make actions
  $("btnSend").addEventListener("click", sendOffer);

  // Drop zones
  wireDrop("pkgYou", (p)=>{
    if(S.tab!=="make") return;
    if(p.team !== S.my) return;
    if(!S.pkgYou.includes(p.name)) S.pkgYou.push(p.name);
    renderMake();
  });
  wireDrop("pkgThey", (p)=>{
    if(S.tab!=="make") return;
    const target = $("targetTeam").value;
    if(p.team !== target) return;
    if(!S.pkgThey.includes(p.name)) S.pkgThey.push(p.name);
    renderMake();
  });

  // Seed UI
  $("log").innerHTML = `<div class="muted">Start a run to begin.</div>`;
}

document.addEventListener("DOMContentLoaded", ()=>{
  try { init(); }
  catch(e){ console.error("Init failed:", e); alert("Init error. Open console (F12)."); }
});
</script>

</body>
</html>
