<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fast Food Trade Machine ‚Äî Negotiation Mode</title>
  <style>
    :root {
      --bg0:#070a12;
      --bg1:#0b0f19;
      --card:#0f1629;
      --ink:#e8eefc;
      --muted:#b8c5e6;
      --line:#1d2740;
      --line2:#233055;
      --good:#6ef3b2;
      --bad:#ff7c7c;
      --warn:#ffd27c;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(circle at 10% 10%, rgba(255, 0, 122, .28), transparent 40%),
        radial-gradient(circle at 90% 20%, rgba(0, 200, 255, .25), transparent 42%),
        radial-gradient(circle at 30% 85%, rgba(255, 210, 0, .22), transparent 45%),
        radial-gradient(circle at 80% 90%, rgba(120, 255, 120, .18), transparent 45%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Fast-food vibe collage (no real logos) */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.22;
      filter:saturate(1.25) contrast(1.05);
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='520'%3E%3Crect width='100%25' height='100%25' fill='none'/%3E%3Cg font-family='Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji' font-size='48'%3E%3Ctext x='28' y='92'%3E%F0%9F%8D%94%3C/text%3E%3Ctext x='158' y='142'%3E%F0%9F%8D%9F%3C/text%3E%3Ctext x='310' y='112'%3E%F0%9F%8D%97%3C/text%3E%3Ctext x='420' y='182'%3E%F0%9F%A5%A4%3C/text%3E%3Ctext x='92' y='290'%3E%F0%9F%8C%AE%3C/text%3E%3Ctext x='312' y='302'%3E%F0%9F%A5%97%3C/text%3E%3Ctext x='190' y='412'%3E%F0%9F%8D%A6%3C/text%3E%3Ctext x='420' y='420'%3E%F0%9F%8D%A9%3C/text%3E%3Ctext x='54' y='462'%3E%F0%9F%8D%AA%3C/text%3E%3C/g%3E%3C/svg%3E");
      background-repeat:repeat;
      transform: rotate(-6deg) scale(1.06);
    }

    header{
      padding:16px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(15, 22, 41, .85);
      backdrop-filter: blur(8px);
      position:sticky; top:0; z-index:10;
    }
    header h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    header p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; }

    .wrap{ max-width:1250px; margin:0 auto; padding: 12px 12px 36px; }
    .card{
      background:rgba(15, 22, 41, .9);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      box-shadow:0 10px 25px rgba(0,0,0,.28);
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select{
      background:#0b1020; color:var(--ink);
      border:1px solid var(--line2);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
    }

    button{
      background:#1e2a4d;
      color:var(--ink);
      border:1px solid #2a3a66;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    button:hover{ filter:brightness(1.08); }
    button.ghost{ background:transparent; border:1px dashed #2a3a66; color:var(--muted); }
    button.good{ background:#153a2a; border-color:#2a664a; }
    button.danger{ background:#3a1b2a; border-color:#5a2741; }

    .muted{ color:var(--muted); font-size:12px; }
    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a3a66; background:#0b1020; color:#cfe0ff; }

    /* SCOREBOARD */
    .scoreboard{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:10px;
      align-items:stretch;
      margin-top:12px;
    }
    .score{
      border:1px solid var(--line2);
      border-radius:14px;
      background:rgba(11,16,32,.75);
      padding:10px 12px;
    }
    .score .team{ font-weight:900; font-size:14px; }
    .score .total{ font-weight:950; font-size:28px; margin-top:4px; font-variant-numeric: tabular-nums; }
    .centerBox{
      border:1px solid var(--line2);
      border-radius:14px;
      background:rgba(11,16,32,.55);
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      min-width: 220px;
      text-align:center;
    }
    .status{ font-weight:950; font-size:16px; }
    .ok{ color:var(--good); }
    .bad{ color:var(--bad); }
    .warn{ color:var(--warn); }
    .diff{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }

    /* ROSTER GRID WITH PHOTO TILES */
    .rosterGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 560px){ .rosterGrid{ grid-template-columns: 1fr; } }

    .tile{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--line2);
      border-radius:14px;
      background:rgba(11,16,32,.75);
      padding:10px;
      cursor:grab;
      user-select:none;
    }
    .tile:active{ cursor:grabbing; }
    .thumb{
      width:54px; height:54px;
      border-radius:14px;
      border:1px solid var(--line2);
      overflow:hidden;
      background:#0b1020;
      flex:0 0 auto;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tile .name{ font-weight:900; }
    .tile .meta{ font-size:12px; color:var(--muted); margin-top:2px; }
    .valTag{
      margin-left:auto;
      display:flex; flex-direction:column;
      align-items:flex-end;
      gap:4px;
      font-variant-numeric: tabular-nums;
    }
    .valTag .v{ font-weight:950; font-size:16px; }
    .valTag .hint{ font-size:11px; color:var(--muted); }

    /* TRADE DROP ZONES */
    .dropWrap{
      margin-top:10px;
      border:1px solid var(--line2);
      border-radius:14px;
      background:rgba(11,16,32,.55);
      padding:10px;
    }
    .dropTitle{
      display:flex; justify-content:space-between; align-items:baseline;
      margin-bottom:8px;
    }
    .dropZone{
      min-height:96px;
      border:2px dashed rgba(184,197,230,.22);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-start;
    }
    .dropZone.dragover{
      border-color: var(--good);
      background: rgba(110, 243, 178, 0.06);
    }

    .chip{
      display:flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--line2);
      border-radius:999px;
      background:rgba(15, 22, 41, .85);
      padding:6px 8px 6px 6px;
      max-width: 100%;
    }
    .chip .mini{
      width:28px; height:28px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--line2);
      background:#0b1020;
      flex: 0 0 auto;
    }
    .chip .mini img{ width:100%; height:100%; object-fit:cover; display:block; }
    .chip .txt{
      display:flex; flex-direction:column; gap:2px;
      min-width: 0;
    }
    .chip .txt b{
      font-size:12px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 260px;
    }
    .chip .txt span{ font-size:11px; color:var(--muted); font-variant-numeric: tabular-nums; }
    .chip button{
      padding:6px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #2a3a66;
      background:transparent;
      color:var(--muted);
      font-weight:900;
    }

    /* COUNTEROFFERS */
    .counterGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .counterGrid{ grid-template-columns:1fr; } }

    .counterCard{
      border:1px solid var(--line2);
      border-radius:14px;
      background:rgba(11,16,32,.55);
      padding:10px;
    }
    .counterCard h3{ margin:0; font-size:13px; }
    .counterCard p{ margin:8px 0 0; font-size:12px; color:var(--muted); line-height:1.35; }
    .counterCard .actions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }

    .footer{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.35; }
    .divider{ height:1px; background:var(--line); margin:10px 0; }
  </style>
</head>

<body>
<header>
  <h1>üçî Fast Food Trade Machine ‚Äî Negotiation Mode</h1>
  <p>Drag photo tiles into each side. Ask for counteroffers (max 3), accept one, then execute the trade.</p>
</header>

<div class="wrap">

  <div class="card">
    <div class="controls">
      <label class="muted">Team A</label>
      <select id="teamA"></select>

      <label class="muted">Team B</label>
      <select id="teamB"></select>

      <label class="muted">Fairness</label>
      <select id="window">
        <option value="5">¬±5 strict</option>
        <option value="8" selected>¬±8 normal</option>
        <option value="12">¬±12 loose</option>
      </select>

      <label class="muted">Chaos Rules</label>
      <select id="chaos">
        <option value="0">Off</option>
        <option value="1" selected>On</option>
      </select>

      <button id="swap" class="ghost">Swap Teams</button>
      <button id="reset" class="ghost">Reset Trade</button>

      <span class="pillrow" style="margin-left:auto; margin-top:0;">
        <span class="pill">Sauce +6</span>
        <span class="pill">LTO +8</span>
        <span class="pill">Iconic +5</span>
        <span class="pill">Broken ‚àí7</span>
        <span class="pill">Speed +3</span>
      </span>
    </div>

    <div class="scoreboard">
      <div class="score">
        <div class="team" id="aName">Team A</div>
        <div class="total" id="aTotal">0</div>
      </div>

      <div class="centerBox">
        <div class="status warn" id="statusText">Add items to both sides</div>
        <div class="diff" id="diffText">Then the machine will approve/reject and negotiate.</div>
        <div class="divider" style="width:100%; margin:10px 0;"></div>
        <div class="muted" id="negText">Counteroffers left: <b id="cLeft">3</b> ‚Ä¢ GM Mood: <b id="mood">Neutral üòê</b></div>
      </div>

      <div class="score">
        <div class="team" id="bName">Team B</div>
        <div class="total" id="bTotal">0</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="controls">
      <button id="askCounter" class="ghost">Ask for Counteroffer</button>
      <button id="execute" class="good">Execute Trade</button>
      <button id="decline" class="danger">Decline / Walk Away</button>
    </div>

    <div class="counterGrid" id="counterGrid"></div>

    <div class="footer">
      Filming tip: do 3 trades ‚Äî (1) obvious fleece, (2) counteroffer negotiation, (3) ‚Äúblockbuster‚Äù with sauces + LTOs.
    </div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <div class="controls" style="justify-content:space-between;">
        <div>
          <div style="font-weight:950;">Team A Roster</div>
          <div class="muted" id="aCount"></div>
        </div>
        <div class="muted">Drag tiles into ‚ÄúTeam A gives‚Äù</div>
      </div>

      <div class="rosterGrid" id="rosterA"></div>

      <div class="dropWrap">
        <div class="dropTitle">
          <b>Team A gives</b>
          <span class="muted">Drop items here</span>
        </div>
        <div class="dropZone" id="givesA"></div>
      </div>
    </div>

    <div class="card">
      <div class="controls" style="justify-content:space-between;">
        <div>
          <div style="font-weight:950;">Team B Roster</div>
          <div class="muted" id="bCount"></div>
        </div>
        <div class="muted">Drag tiles into ‚ÄúTeam B gives‚Äù</div>
      </div>

      <div class="rosterGrid" id="rosterB"></div>

      <div class="dropWrap">
        <div class="dropTitle">
          <b>Team B gives</b>
          <span class="muted">Drop items here</span>
        </div>
        <div class="dropZone" id="givesB"></div>
      </div>
    </div>
  </div>

</div>

<script>
/*
  IMAGES:
  Put images in /assets/items/
  If any image is missing, it falls back to /assets/items/placeholder.jpg

  IMPORTANT:
  Use AI-generated ‚Äúlook-alike‚Äù product photos with NO logos/text/branding
  (to avoid trademark/copyright headaches).
*/

const DATA_SEED = {
  "McDonald's": [
    { name:"Big Mac", base:86, tags:["iconic"], img:"assets/items/mcd_big-mac.jpg" },
    { name:"Fries", base:80, tags:["iconic","speed"], img:"assets/items/mcd_fries.jpg" },
    { name:"Chicken Nuggets (10pc)", base:78, tags:["iconic"], img:"assets/items/mcd_nuggets.jpg" },
    { name:"McFlurry", base:74, tags:["broken"], img:"assets/items/mcd_mcflurry.jpg" },
    { name:"Egg McMuffin", base:76, tags:["iconic"], img:"assets/items/mcd_egg-mcmuffin.jpg" },
    { name:"Hash Browns", base:70, tags:["speed"], img:"assets/items/mcd_hash-browns.jpg" },
    { name:"Filet-O-Fish", base:72, tags:["iconic"], img:"assets/items/mcd_filet-o-fish.jpg" }
  ],

  "Taco Bell": [
    { name:"Baja Blast", base:90, tags:["iconic"], img:"assets/items/tb_baja-blast.jpg" },
    { name:"Crunchwrap Supreme", base:88, tags:["iconic"], img:"assets/items/tb_crunchwrap.jpg" },
    { name:"Doritos Locos Taco", base:84, tags:["iconic"], img:"assets/items/tb_doritos-locos.jpg" },
    { name:"Quesadilla", base:80, tags:["iconic"], img:"assets/items/tb_quesadilla.jpg" },
    { name:"Nacho Fries (LTO)", base:83, tags:["lto"], img:"assets/items/tb_nacho-fries.jpg" },
    { name:"Fire Sauce", base:64, tags:["sauce"], img:"assets/items/tb_fire-sauce.jpg" },
    { name:"Cinnamon Twists", base:70, tags:["dessert"], img:"assets/items/tb_cinnamon-twists.jpg" }
  ],

  "Chick-fil-A": [
    { name:"Chicken Sandwich", base:90, tags:["iconic"], img:"assets/items/cfa_chicken-sandwich.jpg" },
    { name:"Spicy Chicken Sandwich", base:92, tags:["iconic"], img:"assets/items/cfa_spicy-sandwich.jpg" },
    { name:"Waffle Fries", base:86, tags:["iconic","speed"], img:"assets/items/cfa_waffle-fries.jpg" },
    { name:"Nuggets (12ct)", base:82, tags:["iconic"], img:"assets/items/cfa_nuggets.jpg" },
    { name:"Chick-fil-A Sauce", base:66, tags:["sauce"], img:"assets/items/cfa_sauce.jpg" },
    { name:"Lemonade", base:75, tags:["iconic"], img:"assets/items/cfa_lemonade.jpg" },
    { name:"Mac & Cheese", base:74, tags:["iconic"], img:"assets/items/cfa_mac.jpg" }
  ],

  "Raising Cane's": [
    { name:"Box Combo", base:88, tags:["iconic"], img:"assets/items/rc_box-combo.jpg" },
    { name:"Chicken Fingers", base:86, tags:["iconic"], img:"assets/items/rc_chicken-fingers.jpg" },
    { name:"Cane's Sauce", base:70, tags:["sauce","iconic"], img:"assets/items/rc_sauce.jpg" },
    { name:"Texas Toast", base:76, tags:["iconic"], img:"assets/items/rc_texas-toast.jpg" },
    { name:"Crinkle Fries", base:80, tags:["speed"], img:"assets/items/rc_fries.jpg" },
    { name:"Lemonade", base:74, tags:["iconic"], img:"assets/items/rc_lemonade.jpg" },
    { name:"Coleslaw", base:66, tags:[], img:"assets/items/rc_coleslaw.jpg" }
  ],

  "Burger King": [
    { name:"Whopper", base:84, tags:["iconic"], img:"assets/items/bk_whopper.jpg" },
    { name:"Fries", base:76, tags:["speed"], img:"assets/items/bk_fries.jpg" },
    { name:"Onion Rings", base:73, tags:["iconic"], img:"assets/items/bk_onion-rings.jpg" },
    { name:"Chicken Fries", base:76, tags:["iconic"], img:"assets/items/bk_chicken-fries.jpg" },
    { name:"Impossible Whopper (LTO)", base:78, tags:["lto"], img:"assets/items/bk_impossible-whopper.jpg" },
    { name:"Breakfast Croissan'wich", base:72, tags:["iconic"], img:"assets/items/bk_croissanwich.jpg" },
    { name:"Chocolate Pie", base:70, tags:["dessert"], img:"assets/items/bk_pie.jpg" }
  ],

  "Chipotle": [
    { name:"Burrito", base:86, tags:["iconic"], img:"assets/items/chip_burrito.jpg" },
    { name:"Bowl", base:86, tags:["iconic"], img:"assets/items/chip_bowl.jpg" },
    { name:"Chips & Guac", base:80, tags:["upgrade","iconic"], img:"assets/items/chip_chips-guac.jpg" },
    { name:"Queso", base:74, tags:["upgrade"], img:"assets/items/chip_queso.jpg" },
    { name:"Barbacoa", base:82, tags:["iconic"], img:"assets/items/chip_barbacoa.jpg" },
    { name:"Vinaigrette", base:64, tags:["sauce"], img:"assets/items/chip_vinaigrette.jpg" },
    { name:"Hot Salsa", base:64, tags:["sauce"], img:"assets/items/chip_hot-salsa.jpg" }
  ],

  "Panda Express": [
    { name:"Orange Chicken", base:90, tags:["iconic"], img:"assets/items/pe_orange-chicken.jpg" },
    { name:"Chow Mein", base:82, tags:["iconic"], img:"assets/items/pe_chow-mein.jpg" },
    { name:"Fried Rice", base:80, tags:["iconic"], img:"assets/items/pe_fried-rice.jpg" },
    { name:"Beijing Beef", base:84, tags:["iconic"], img:"assets/items/pe_beijing-beef.jpg" },
    { name:"Honey Walnut Shrimp (LTO)", base:86, tags:["lto"], img:"assets/items/pe_walnut-shrimp.jpg" },
    { name:"Super Greens", base:70, tags:[], img:"assets/items/pe_super-greens.jpg" },
    { name:"Fortune Cookie", base:62, tags:["nostalgia"], img:"assets/items/pe_fortune-cookie.jpg" }
  ],

  "Subway": [
    { name:"Footlong Sub", base:80, tags:["iconic"], img:"assets/items/sub_footlong.jpg" },
    { name:"Italian B.M.T.", base:82, tags:["iconic"], img:"assets/items/sub_italian-bmt.jpg" },
    { name:"Meatball Marinara", base:80, tags:["iconic"], img:"assets/items/sub_meatball.jpg" },
    { name:"Tuna Sub", base:74, tags:["iconic"], img:"assets/items/sub_tuna.jpg" },
    { name:"Cookies", base:70, tags:["dessert"], img:"assets/items/sub_cookies.jpg" },
    { name:"Chipotle Southwest Sauce", base:64, tags:["sauce"], img:"assets/items/sub_chipotle-sauce.jpg" },
    { name:"Soft Pretzel (LTO)", base:72, tags:["lto"], img:"assets/items/sub_pretzel.jpg" }
  ],

  "Domino's": [
    { name:"Pepperoni Pizza", base:90, tags:["iconic"], img:"assets/items/dom_pepperoni-pizza.jpg" },
    { name:"Cheesy Bread", base:82, tags:["iconic"], img:"assets/items/dom_cheesy-bread.jpg" },
    { name:"Chicken Wings", base:84, tags:["iconic"], img:"assets/items/dom_wings.jpg" },
    { name:"Cinnamon Twists", base:74, tags:["dessert"], img:"assets/items/dom_cinnamon-twists.jpg" },
    { name:"Lava Cake", base:78, tags:["dessert","iconic"], img:"assets/items/dom_lava-cake.jpg" },
    { name:"Garlic Dip", base:64, tags:["sauce"], img:"assets/items/dom_garlic-dip.jpg" },
    { name:"Stuffed Crust (LTO)", base:82, tags:["lto"], img:"assets/items/dom_stuffed-crust.jpg" }
  ],

  "Wendy's": [
    { name:"Baconator", base:88, tags:["iconic"], img:"assets/items/wen_baconator.jpg" },
    { name:"Dave's Single", base:82, tags:["iconic"], img:"assets/items/wen_daves-single.jpg" },
    { name:"Spicy Nuggets", base:83, tags:["iconic"], img:"assets/items/wen_spicy-nuggets.jpg" },
    { name:"Spicy Chicken Sandwich", base:84, tags:["iconic"], img:"assets/items/wen_spicy-chicken.jpg" },
    { name:"Fries", base:76, tags:["speed"], img:"assets/items/wen_fries.jpg" },
    { name:"Frosty", base:80, tags:["iconic"], img:"assets/items/wen_frosty.jpg" },
    { name:"Chili", base:72, tags:["iconic"], img:"assets/items/wen_chili.jpg" }
  ]
};

const BONUS = { sauce: 6, lto: 8, iconic: 5, broken: -7, speed: 3 };
function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }
function escapeHtml(s){ return (s+"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
const el = (id) => document.getElementById(id);

let state = {
  DATA: deepClone(DATA_SEED),
  aTeam: Object.keys(DATA_SEED)[0],
  bTeam: Object.keys(DATA_SEED)[1],
  givesA: [],
  givesB: [],
  window: 8,
  chaosOn: true,
  countersLeft: 3,
  gmMood: 0, // -100..100
  lastCounters: []
};

function itemValue(item){
  if(!item) return 0;
  if(!state.chaosOn) return item.base;
  let v = item.base;
  const tags = new Set(item.tags || []);
  if(tags.has("sauce")) v += BONUS.sauce;
  if(tags.has("lto")) v += BONUS.lto;
  if(tags.has("iconic")) v += BONUS.iconic;
  if(tags.has("broken")) v += BONUS.broken;
  if(tags.has("speed")) v += BONUS.speed;
  return v;
}

function moodLabel(){
  if(state.gmMood >= 40) return "Happy üòÑ";
  if(state.gmMood >= 10) return "Warm üôÇ";
  if(state.gmMood > -10) return "Neutral üòê";
  if(state.gmMood > -40) return "Annoyed üòí";
  return "Hostile üò§";
}

function tradeTotals(){
  const sum = (team, names) => names.reduce((acc, n) => {
    const it = (state.DATA[team] || []).find(x => x.name === n);
    return acc + itemValue(it);
  }, 0);
  return { a: sum(state.aTeam, state.givesA), b: sum(state.bTeam, state.givesB) };
}

function evaluate(){
  const {a,b} = tradeTotals();
  const diff = a - b;
  const abs = Math.abs(diff);

  if(state.givesA.length === 0 || state.givesB.length === 0){
    return { ok:false, kind:"warn", status:"Add items to both sides", detail:"Drag photo tiles into each ‚Äúgives‚Äù box to start.", a,b,diff,abs };
  }
  if(abs <= state.window){
    return { ok:true, kind:"ok", status:"‚úÖ Trade Approved", detail:`Fair within ¬±${state.window}.`, a,b,diff,abs };
  }

  const underSide = diff < 0 ? "A" : "B";
  const overSide  = diff < 0 ? "B" : "A";
  const need = abs - state.window;

  const underTeam = underSide === "A" ? state.aTeam : state.bTeam;
  const overTeam  = overSide  === "A" ? state.aTeam : state.bTeam;

  return {
    ok:false, kind:"bad",
    status:"‚ùå Trade Rejected",
    detail:`${underTeam} is short by about ${need} value.`,
    a,b,diff,abs,need,underSide,overSide,underTeam,overTeam
  };
}

function imgTag(src, alt){
  const safeAlt = escapeHtml(alt);
  const safeSrc = src ? src : "";
  return `<img src="${safeSrc}" alt="${safeAlt}" loading="lazy"
    onerror="this.onerror=null;this.src='assets/items/placeholder.jpg';" />`;
}

function renderRoster(team, containerId, side){
  const roster = (state.DATA[team] || [])
    .map(x => ({...x, v:itemValue(x)}))
    .sort((p,q)=> q.v - p.v);

  el(side === "A" ? "aCount" : "bCount").textContent = `${roster.length} items`;
  const c = el(containerId);
  c.innerHTML = "";

  for(const it of roster){
    const div = document.createElement("div");
    div.className = "tile";
    div.draggable = true;

    div.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", JSON.stringify({ from: side, name: it.name }));
    });

    div.innerHTML = `
      <div class="thumb">${imgTag(it.img, it.name)}</div>
      <div style="min-width:0;">
        <div class="name">${escapeHtml(it.name)}</div>
        <div class="meta">${(it.tags||[]).map(t=>`#${escapeHtml(t)}`).join(" ")}</div>
      </div>
      <div class="valTag">
        <div class="v">${it.v}</div>
        <div class="hint">drag</div>
      </div>
    `;
    c.appendChild(div);
  }
}

function renderGives(side, zoneId){
  const team = side === "A" ? state.aTeam : state.bTeam;
  const list = side === "A" ? state.givesA : state.givesB;
  const zone = el(zoneId);
  zone.innerHTML = "";

  if(list.length === 0){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "Drop items here‚Ä¶";
    zone.appendChild(empty);
    return;
  }

  for(const name of list){
    const it = (state.DATA[team] || []).find(x => x.name === name);
    const v = itemValue(it);

    const chip = document.createElement("div");
    chip.className = "chip";
    chip.innerHTML = `
      <div class="mini">${imgTag(it?.img, name)}</div>
      <div class="txt">
        <b title="${escapeHtml(name)}">${escapeHtml(name)}</b>
        <span>Value: ${v}</span>
      </div>
      <button title="Remove">‚úï</button>
    `;
    chip.querySelector("button").onclick = () => removeFromTrade(side, name);
    zone.appendChild(chip);
  }
}

function renderScoreboard(){
  const {a,b,diff} = tradeTotals();
  el("aName").textContent = state.aTeam;
  el("bName").textContent = state.bTeam;
  el("aTotal").textContent = a;
  el("bTotal").textContent = b;

  const res = evaluate();
  const st = el("statusText");
  st.className = "status " + (res.kind === "ok" ? "ok" : res.kind === "bad" ? "bad" : "warn");
  st.textContent = res.status;

  const diffText = el("diffText");
  if(res.kind === "warn"){
    diffText.textContent = res.detail;
  } else if(res.kind === "ok"){
    const who = diff === 0 ? "Perfectly even" : (diff > 0 ? `${state.aTeam} is overpaying by ${diff}` : `${state.bTeam} is overpaying by ${Math.abs(diff)}`);
    diffText.textContent = `${res.detail} ‚Ä¢ ${who}`;
  } else {
    const who = res.diff > 0 ? `${state.aTeam} is OVERPAYING by ${res.diff}` : `${state.bTeam} is OVERPAYING by ${Math.abs(res.diff)}`;
    diffText.textContent = `${res.detail} ‚Ä¢ ${who}`;
  }

  el("cLeft").textContent = String(state.countersLeft);
  el("mood").textContent = moodLabel();
}

function setButtons(){
  const res = evaluate();
  el("execute").disabled = !res.ok;
  el("askCounter").disabled = res.ok || res.kind === "warn" || state.countersLeft <= 0;
}

function addToTrade(side, name){
  const team = side === "A" ? state.aTeam : state.bTeam;
  const roster = state.DATA[team] || [];
  if(!roster.some(x => x.name === name)) return;

  const list = side === "A" ? state.givesA : state.givesB;
  if(list.includes(name)) return;
  list.push(name);
  state.lastCounters = [];
  rerender();
}

function removeFromTrade(side, name){
  const list = side === "A" ? state.givesA : state.givesB;
  const i = list.indexOf(name);
  if(i >= 0) list.splice(i, 1);
  state.lastCounters = [];
  rerender();
}

function wireDrop(zoneId, targetSide){
  const z = el(zoneId);
  z.addEventListener("dragover", (ev) => { ev.preventDefault(); z.classList.add("dragover"); });
  z.addEventListener("dragleave", () => z.classList.remove("dragover"));
  z.addEventListener("drop", (ev) => {
    ev.preventDefault();
    z.classList.remove("dragover");
    try{
      const payload = JSON.parse(ev.dataTransfer.getData("text/plain"));
      addToTrade(targetSide, payload.name);
    }catch{}
  });
}

function askCounter(){
  const res = evaluate();
  if(res.ok || res.kind !== "bad") return;
  if(state.countersLeft <= 0) return;

  state.countersLeft -= 1;

  const penalty = Math.min(25, Math.max(6, Math.floor((res.need || 10) / 6) * 6));
  state.gmMood = Math.max(-100, state.gmMood - penalty);

  state.lastCounters = buildCounterOptions(res);
  renderCounters();
  rerender();
}

function buildCounterOptions(res){
  const underSide = res.underSide;
  const overSide  = res.overSide;
  const underTeam = res.underTeam;
  const overTeam  = res.overTeam;
  const need = res.need || 10;

  const underList = underSide === "A" ? state.givesA : state.givesB;
  const overList  = overSide  === "A" ? state.givesA : state.givesB;

  const underRoster = (state.DATA[underTeam] || [])
    .map(it => ({...it, v:itemValue(it)}))
    .filter(it => !underList.includes(it.name))
    .sort((a,b)=> b.v - a.v);

  const overIncluded = (overList || [])
    .map(n => {
      const it = (state.DATA[overTeam] || []).find(x=>x.name===n);
      return it ? {...it, v:itemValue(it)} : {name:n, v:0};
    })
    .sort((a,b)=> b.v - a.v);

  const counters = [];

  const addOne = underRoster.find(it => it.v >= need) || underRoster[0];
  if(addOne){
    counters.push({
      title: "Counter 1 (Add)",
      description: `${underTeam} adds ‚Äú${addOne.name}‚Äù (+${addOne.v})`,
      apply: () => addToTrade(underSide, addOne.name)
    });
  }

  let pair = null;
  for(let i=0;i<Math.min(underRoster.length, 10) && !pair;i++){
    for(let j=i+1;j<Math.min(underRoster.length, 12);j++){
      const s = underRoster[i].v + underRoster[j].v;
      if(s >= need && s <= need + 14){ pair = [underRoster[i], underRoster[j]]; break; }
    }
  }
  if(pair){
    counters.push({
      title: "Counter 2 (Add 2)",
      description: `${underTeam} adds ‚Äú${pair[0].name}‚Äù (+${pair[0].v}) and ‚Äú${pair[1].name}‚Äù (+${pair[1].v})`,
      apply: () => { addToTrade(underSide, pair[0].name); addToTrade(underSide, pair[1].name); }
    });
  }

  const removeOne = overIncluded.find(it => it.v >= need) || overIncluded[overIncluded.length-1];
  if(removeOne){
    counters.push({
      title: "Counter 3 (Remove)",
      description: `${overTeam} removes ‚Äú${removeOne.name}‚Äù (‚àí${removeOne.v})`,
      apply: () => removeFromTrade(overSide, removeOne.name)
    });
  }

  while(counters.length < 3){
    counters.push({ title:`Counter ${counters.length+1}`, description:"No clean counter found ‚Äî try changing items.", apply: () => {} });
  }
  return counters.slice(0,3);
}

function renderCounters(){
  const grid = el("counterGrid");
  grid.innerHTML = "";

  const counters = state.lastCounters.length ? state.lastCounters : [
    {title:"Counter 1", description:"Ask for a counteroffer to see options.", apply:()=>{}},
    {title:"Counter 2", description:"Counteroffers appear here.", apply:()=>{}},
    {title:"Counter 3", description:"Accept one to auto-adjust the trade.", apply:()=>{}}
  ];

  counters.forEach((c) => {
    const card = document.createElement("div");
    card.className = "counterCard";
    card.innerHTML = `
      <h3>${escapeHtml(c.title)}</h3>
      <p>${escapeHtml(c.description)}</p>
      <div class="actions"><button class="good">Accept</button></div>
    `;
    const btn = card.querySelector("button");
    btn.disabled = !state.lastCounters.length;
    btn.onclick = () => {
      c.apply();
      state.gmMood = Math.min(100, state.gmMood + 8);
      rerender();
    };
    grid.appendChild(card);
  });
}

function executeTrade(){
  const res = evaluate();
  if(!res.ok) return;

  const aRoster = state.DATA[state.aTeam] || [];
  const bRoster = state.DATA[state.bTeam] || [];

  const aGivesItems = state.givesA.map(n => aRoster.find(x=>x.name===n)).filter(Boolean);
  const bGivesItems = state.givesB.map(n => bRoster.find(x=>x.name===n)).filter(Boolean);

  state.DATA[state.aTeam] = aRoster.filter(x => !state.givesA.includes(x.name)).concat(bGivesItems);
  state.DATA[state.bTeam] = bRoster.filter(x => !state.givesB.includes(x.name)).concat(aGivesItems);

  state.givesA = [];
  state.givesB = [];
  state.countersLeft = 3;
  state.lastCounters = [];
  state.gmMood = Math.min(100, state.gmMood + 12);
  rerender();
}

function declineTrade(){
  state.givesA = [];
  state.givesB = [];
  state.countersLeft = 3;
  state.lastCounters = [];
  state.gmMood = Math.max(-100, state.gmMood - 4);
  rerender();
}

function buildTeamSelects(){
  const teams = Object.keys(state.DATA);
  const a = el("teamA");
  const b = el("teamB");
  a.innerHTML = ""; b.innerHTML = "";
  teams.forEach(t => {
    const oa = document.createElement("option");
    oa.value = t; oa.textContent = t;
    const ob = oa.cloneNode(true);
    a.appendChild(oa); b.appendChild(ob);
  });
  a.value = state.aTeam;
  b.value = state.bTeam;
}

function swapTeams(){
  const t = state.aTeam;
  state.aTeam = state.bTeam;
  state.bTeam = t;
  resetTrade();
}

function resetTrade(){
  state.givesA = [];
  state.givesB = [];
  state.countersLeft = 3;
  state.lastCounters = [];
  rerender();
}

function rerender(){
  renderRoster(state.aTeam, "rosterA", "A");
  renderRoster(state.bTeam, "rosterB", "B");
  renderGives("A", "givesA");
  renderGives("B", "givesB");
  renderScoreboard();
  setButtons();
  if(!state.lastCounters.length) renderCounters();
}

function init(){
  buildTeamSelects();
  wireDrop("givesA", "A");
  wireDrop("givesB", "B");

  el("teamA").addEventListener("change", (e) => { state.aTeam = e.target.value; resetTrade(); });
  el("teamB").addEventListener("change", (e) => { state.bTeam = e.target.value; resetTrade(); });

  el("window").addEventListener("change", (e) => { state.window = parseInt(e.target.value, 10); rerender(); });
  el("chaos").addEventListener("change", (e) => { state.chaosOn = e.target.value === "1"; rerender(); });

  el("swap").addEventListener("click", swapTeams);
  el("reset").addEventListener("click", resetTrade);
  el("askCounter").addEventListener("click", askCounter);
  el("execute").addEventListener("click", executeTrade);
  el("decline").addEventListener("click", declineTrade);

  renderCounters();
  rerender();
}
init();
</script>
</body>
</html>
